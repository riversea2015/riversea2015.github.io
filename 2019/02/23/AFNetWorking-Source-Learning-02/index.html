<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>AFNetWorking æºç å­¦ä¹ ç¬”è®° â˜ NSURLSession | riversea2015</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="article">
<meta property="og:title" content="AFNetWorking æºç å­¦ä¹ ç¬”è®° â˜ NSURLSession">
<meta property="og:url" content="https://devhe.com/2019/02/23/AFNetWorking-Source-Learning-02/index.html">
<meta property="og:site_name" content="riversea2015">
<meta property="og:locale">
<meta property="og:image" content="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8a08da576d4e4d5ba2f93c517160fc85~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e7c40e7ea5d84a0ba013e4f8b4f08e13~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e80abea104eb4724a835b824f5f40aed~tplv-k3u1fbpfcp-watermark.image">
<meta property="article:published_time" content="2019-02-23T15:00:10.000Z">
<meta property="article:modified_time" content="2022-08-28T06:46:00.491Z">
<meta property="article:author" content="He Hai">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8a08da576d4e4d5ba2f93c517160fc85~tplv-k3u1fbpfcp-watermark.image">
  
    <link rel="alternate" href="/atom.xml" title="riversea2015" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">riversea2015</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Stay Hungry, Stay Young.</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Suche"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Suche"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://devhe.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-AFNetWorking-Source-Learning-02" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/02/23/AFNetWorking-Source-Learning-02/" class="article-date">
  <time class="dt-published" datetime="2019-02-23T15:00:10.000Z" itemprop="datePublished">2019-02-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      AFNetWorking æºç å­¦ä¹ ç¬”è®° â˜ NSURLSession
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8a08da576d4e4d5ba2f93c517160fc85~tplv-k3u1fbpfcp-watermark.image" alt="AFNetWorking_cover.png"></p>
<span id="more"></span>

<h3 id="ä¸€ã€å‰è¨€"><a href="#ä¸€ã€å‰è¨€" class="headerlink" title="ä¸€ã€å‰è¨€"></a>ä¸€ã€å‰è¨€</h3><p>æœ¬æ–‡æ˜¯ AFNetWorking æºç å­¦ä¹ ç¬”è®°çš„ç¬¬äºŒç¯‡ï¼Œä»æœ¬ç¯‡å¼€å§‹æ¯æ¬¡ä»‹ç»å››ä¸ªéƒ¨åˆ†ä¸­çš„ä¸€ä¸ªï¼ŒæŒ‰é¡ºåºå…ˆä»‹ç»ç¬¬ä¸€éƒ¨åˆ† â€“ NSURLSession ç›®å½•ä¸‹çš„ä¸¤ä¸ªå…³é”®ç±» AFHTTPSessionManager å’Œ AFURLSessionManagerã€‚</p>
<p>æ³¨ï¼šæ ‡é¢˜å®¹æ˜“è®©äººè¯¯è§£ï¼Œå…¶å®æŒ‡çš„æ˜¯ AFNetWorking æºç ä¸­çš„ NSURLSession ç›®å½•ï¼Œè€Œä¸æ˜¯çœŸçš„ NSURLSession è¿™ä¸ªç±»ã€‚</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e7c40e7ea5d84a0ba013e4f8b4f08e13~tplv-k3u1fbpfcp-watermark.image" alt="AFNetWorking-NSURLSession.png"></p>
<h3 id="äºŒã€æ­£æ–‡"><a href="#äºŒã€æ­£æ–‡" class="headerlink" title="äºŒã€æ­£æ–‡"></a>äºŒã€æ­£æ–‡</h3><p>æˆ‘ä»¬ä»æ•´ä¸ªæ¡†æ¶å¯¹å¤–çš„æœ€ç›´æ¥æ¥å£ AFHTTPSessionManager.h æ–‡ä»¶å¼€å§‹æŸ¥çœ‹ï¼Œæ­¤æ–‡ä»¶ä¸»è¦åˆ†ä¸‰éƒ¨åˆ†ï¼š</p>
<h5 id="ç¬¬ä¸€éƒ¨åˆ†ï¼š4ä¸ªåŸºæœ¬å±æ€§ï¼š"><a href="#ç¬¬ä¸€éƒ¨åˆ†ï¼š4ä¸ªåŸºæœ¬å±æ€§ï¼š" class="headerlink" title="ç¬¬ä¸€éƒ¨åˆ†ï¼š4ä¸ªåŸºæœ¬å±æ€§ï¼š"></a>ç¬¬ä¸€éƒ¨åˆ†ï¼š4ä¸ªåŸºæœ¬å±æ€§ï¼š</h5><p>â‘ baseURLï¼šé¡¾åæ€ä¹‰ï¼ŒåŸºç¡€çš„ URL ï¼Œå¯¹äºåŒä¸€ä¸ª Appï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œè¯·æ±‚ url çš„å‰åŠéƒ¨åˆ†éƒ½æ˜¯ç›¸åŒçš„ï¼Œå°†è¿™ä¸€éƒ¨åˆ†èµ‹å€¼ç»™ baseURLï¼Œå‘é€è¯·æ±‚æ—¶å°±å¯ä»¥ä½¿ç”¨ç›¸å¯¹è·¯å¾„äº†ã€‚<br>â‘¡requestSerializerï¼šè¯·æ±‚çš„åºåˆ—åŒ–ç±»ï¼Œè´Ÿè´£æ‹¼æ¥å‚æ•°ï¼ŒåŠå¯¹å‚æ•°çš„ç¼–ç ã€‚<br>â‘¢responseSerializerï¼šè´Ÿè´£å¯¹è¯·æ±‚ç»“æœçš„å¤„ç†ï¼Œ<br>â‘£securityPolicyï¼šå®‰å…¨ç­–ç•¥ç±»ï¼Œè´Ÿè´£å¯¹æœåŠ¡å™¨è¯ä¹¦çš„å†…éƒ¨éªŒè¯ï¼Œå³åœ¨ AFNetWorking å†…éƒ¨å…ˆè¿›è¡Œä¸€æ¬¡éªŒè¯ã€‚</p>
<h5 id="ç¬¬äºŒéƒ¨åˆ†ï¼šåˆ›å»ºåŠåˆå§‹åŒ–æ–¹æ³•"><a href="#ç¬¬äºŒéƒ¨åˆ†ï¼šåˆ›å»ºåŠåˆå§‹åŒ–æ–¹æ³•" class="headerlink" title="ç¬¬äºŒéƒ¨åˆ†ï¼šåˆ›å»ºåŠåˆå§‹åŒ–æ–¹æ³•"></a>ç¬¬äºŒéƒ¨åˆ†ï¼šåˆ›å»ºåŠåˆå§‹åŒ–æ–¹æ³•</h5><p>è™½ç„¶æä¾›äº†3ç§çœ‹ä¼¼ä¸åŒçš„åˆ›å»ºåŠåˆå§‹åŒ–æ–¹æ³•(è§ä¸‹æ–¹ä»£ç )ï¼Œå®é™…ä¸Šå‰ä¸¤è€…åªæ˜¯å¯¹åè€…ä¸åŒç¨‹åº¦çš„å°è£…ï¼Œæœ€ç»ˆéƒ½æ˜¯è°ƒç”¨äº†æœ€åä¸€ä¸ªå‚æ•°æœ€å¤šçš„åˆå§‹åŒ–æ–¹æ³•ã€‚</p>
<p>AFHTTPSessionManager.h</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¹¶éå•ä¾‹ï¼Œä»æ–¹æ³•åå°±å¯ä»¥çœ‹å‡ºæ¥</span></span><br><span class="line">+ (<span class="keyword">instancetype</span>)manager;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithBaseURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithBaseURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</span><br><span class="line">           sessionConfiguration:(<span class="keyword">nullable</span> <span class="built_in">NSURLSessionConfiguration</span> *)configuration <span class="built_in">NS_DESIGNATED_INITIALIZER</span>;</span><br></pre></td></tr></table></figure>

<p>AFHTTPSessionManager.m</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// *** åˆå§‹åŒ– æœ€ç»ˆéƒ½è°ƒç”¨çš„æ˜¯è¿™ä¸ªæ–¹æ³•</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithBaseURL:(<span class="built_in">NSURL</span> *)url</span><br><span class="line">           sessionConfiguration:(<span class="built_in">NSURLSessionConfiguration</span> *)configuration</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 0.è°ƒç”¨çˆ¶ç±»åˆå§‹åŒ–æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">self</span> = [<span class="variable language_">super</span> initWithSessionConfiguration:configuration];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.è°ƒæ•´ url, ç¡®ä¿ NSURL çš„ +URLWithString:relativeToURL:  æ–¹æ³•èƒ½å¤Ÿæ­£å¸¸è°ƒç”¨</span></span><br><span class="line">    <span class="keyword">if</span> ([[url path] length] &gt; <span class="number">0</span> &amp;&amp; ![[url absoluteString] hasSuffix:<span class="string">@&quot;/&quot;</span>]) &#123;</span><br><span class="line">        url = [url URLByAppendingPathComponent:<span class="string">@&quot;&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.åˆå§‹åŒ–æœ¬ç±»çš„å±æ€§</span></span><br><span class="line">    <span class="keyword">self</span>.baseURL = url;</span><br><span class="line">    <span class="keyword">self</span>.requestSerializer = [AFHTTPRequestSerializer serializer];</span><br><span class="line">    <span class="keyword">self</span>.responseSerializer = [AFJSONResponseSerializer serializer];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸€æ­¥å°±æ˜¯è°ƒç”¨çˆ¶ç±»ï¼ˆAFURLSessionManagerï¼‰çš„ initWithSessionConfiguration: æ–¹æ³•åˆå§‹åŒ–ï¼Œç„¶åæ‰æ˜¯åˆå§‹åŒ–è‡ªå·±çš„å±æ€§ï¼Œç‚¹å¼€çˆ¶ç±»æ–¹æ³•çœ‹çœ‹ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// *** init å­ç±»åˆå§‹åŒ–æ—¶ä¼šé€šè¿‡ super è°ƒç”¨ğŸ˜</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithSessionConfiguration:(<span class="built_in">NSURLSessionConfiguration</span> *)configuration &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="variable language_">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ– configurationï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™ä½¿ç”¨é»˜è®¤ï¼Œå³ defaultSessionConfigurationï¼Œé»˜è®¤é…ç½®ä½¿ç”¨çš„æ˜¯æŒä¹…åŒ–çš„ç¡¬ç›˜ç¼“å­˜ï¼Œå­˜å‚¨è¯ä¹¦åˆ°ç”¨æˆ· keychainï¼Œå­˜å‚¨ cookie åˆ° shareCookieã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (!configuration) &#123;</span><br><span class="line">        configuration = [<span class="built_in">NSURLSessionConfiguration</span> defaultSessionConfiguration];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">self</span>.sessionConfiguration = configuration;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»º delegate æ‰€åœ¨çš„æ“ä½œé˜Ÿåˆ—ï¼Œå› ä¸º maxConcurrentOperationCount = 1ï¼Œæ‰€ä»¥æ­¤å¤„æ˜¯ä¸²è¡Œé˜Ÿåˆ—ï¼Œå¦‚æœ &gt; 1ï¼Œåˆ™ä¸ºå¹¶å‘é˜Ÿåˆ—ã€‚</span></span><br><span class="line">    <span class="keyword">self</span>.operationQueue = [[<span class="built_in">NSOperationQueue</span> alloc] init];</span><br><span class="line">    <span class="keyword">self</span>.operationQueue.maxConcurrentOperationCount = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  åˆå§‹åŒ– session</span></span><br><span class="line"><span class="comment">     *  ç”¨äºåè¾¹åˆ›å»ºå„ç§ taskï¼Œè¿™é‡Œè®¾ç½®äº† delegateã€operationQueue å’Œ sessionConfiguration</span></span><br><span class="line"><span class="comment">     *  æ³¨æ„1: è¿™ä¸ª delegate æ˜¯ readonlyï¼Œåªèƒ½é€šè¿‡åˆå§‹åŒ–æ–¹æ³•è®¾ç½®ï¼›</span></span><br><span class="line"><span class="comment">     *  æ³¨æ„2: self.operationQueue é»˜è®¤æ˜¯ä¸²è¡Œé˜Ÿåˆ—ï¼›</span></span><br><span class="line"><span class="comment">     *  æ³¨æ„3: self.sessionConfiguration é»˜è®¤å– defaultSessionConfigurationã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">self</span>.session = [<span class="built_in">NSURLSession</span> sessionWithConfiguration:<span class="keyword">self</span>.sessionConfiguration delegate:<span class="keyword">self</span> delegateQueue:<span class="keyword">self</span>.operationQueue];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨äºå¯¹æ¥å£è¿”å›ç»“æœçš„å¤„ç† - ä¸‹ä¸€ç¯‡è¯¦ç»†è¯´æ˜</span></span><br><span class="line">    <span class="keyword">self</span>.responseSerializer = [AFJSONResponseSerializer serializer];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®é»˜è®¤çš„å®‰å…¨ç­–ç•¥ç±»</span></span><br><span class="line">    <span class="keyword">self</span>.securityPolicy = [AFSecurityPolicy defaultPolicy];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ Apple Watchï¼Œåˆ™ä¸éœ€è¦åˆå§‹åŒ– reachabilityManager</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !TARGET_OS_WATCH</span></span><br><span class="line">    <span class="keyword">self</span>.reachabilityManager = [AFNetworkReachabilityManager sharedManager];</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å­˜æ”¾ task.idenfier ä¸å…¶ delegate ç»„æˆçš„é”®å€¼å¯¹ï¼Œç”¨äºå°†ç³»ç»Ÿæä¾›çš„ä»£ç†æ–¹æ³•è½¬å‘ç»™å…¶ delegate</span></span><br><span class="line">    <span class="keyword">self</span>.mutableTaskDelegatesKeyedByTaskIdentifier = [[<span class="built_in">NSMutableDictionary</span> alloc] init];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–é” ğŸ”</span></span><br><span class="line">    <span class="keyword">self</span>.lock = [[<span class="built_in">NSLock</span> alloc] init];</span><br><span class="line">    <span class="keyword">self</span>.lock.name = AFURLSessionManagerLockName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  ç†è®ºä¸Šï¼Œåœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œåº”è¯¥æ˜¯è¿˜æ²¡æœ‰åˆ›å»º task çš„ã€‚</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *  ä¸€ä¸ªä»£ç è´¡çŒ®è€…ç»™å‡ºçš„è§£é‡Šæ˜¯ I believe this for restoring a session from the background. å³ ä¸ºä»åå°æ¢å¤ä¸€ä¸ª session çš„æƒ…å†µå‡†å¤‡çš„ï¼Œå°†å…¶ä»£ç†çš„æ‰€æœ‰å›è°ƒå…¨éƒ½ç½®ä¸º nilã€‚</span></span><br><span class="line"><span class="comment">     *  è¯¦è§ï¼šhttps://github.com/AFNetworking/AFNetworking/issues/3499</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    [<span class="keyword">self</span>.session getTasksWithCompletionHandler:^(<span class="built_in">NSArray</span> *dataTasks, <span class="built_in">NSArray</span> *uploadTasks, <span class="built_in">NSArray</span> *downloadTasks) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSURLSessionDataTask</span> *task <span class="keyword">in</span> dataTasks) &#123;</span><br><span class="line">            [<span class="keyword">self</span> addDelegateForDataTask:task uploadProgress:<span class="literal">nil</span> downloadProgress:<span class="literal">nil</span> completionHandler:<span class="literal">nil</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSURLSessionUploadTask</span> *uploadTask <span class="keyword">in</span> uploadTasks) &#123;</span><br><span class="line">            [<span class="keyword">self</span> addDelegateForUploadTask:uploadTask progress:<span class="literal">nil</span> completionHandler:<span class="literal">nil</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSURLSessionDownloadTask</span> *downloadTask <span class="keyword">in</span> downloadTasks) &#123;</span><br><span class="line">            [<span class="keyword">self</span> addDelegateForDownloadTask:downloadTask progress:<span class="literal">nil</span> destination:<span class="literal">nil</span> completionHandler:<span class="literal">nil</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ ¸å¿ƒ-å‘é€è¯·æ±‚çš„æ–¹æ³•"><a href="#ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ ¸å¿ƒ-å‘é€è¯·æ±‚çš„æ–¹æ³•" class="headerlink" title="ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ ¸å¿ƒ - å‘é€è¯·æ±‚çš„æ–¹æ³•"></a>ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ ¸å¿ƒ - å‘é€è¯·æ±‚çš„æ–¹æ³•</h5><p>ç»†æ•° AFHTTPSessionManager ä¸­æä¾›çš„ä¸€ç³»åˆ—å‘é€è¯·æ±‚çš„æ–¹æ³•ï¼Œå¯ä»¥å‘ç°ï¼Œå…¶å®ä¸»è¦å¯ä»¥åˆ†ä¸ºä¸¤å¤§ç±»ï¼šä¸€ç±»æ˜¯æ™®é€šçš„ GET&#x2F;POST&#x2F;HEAD&#x2F;PUT&#x2F;PATCH&#x2F;DELETE æ–¹æ³•ï¼Œå¦ä¸€ç±»æ˜¯åŒ…å«å¤åˆç»“æ„ request çš„ POST è¯·æ±‚æ–¹æ³•ã€‚</p>
<h6 id="ç¬¬ä¸€ç±»æ–¹æ³•"><a href="#ç¬¬ä¸€ç±»æ–¹æ³•" class="headerlink" title="ç¬¬ä¸€ç±»æ–¹æ³•"></a>ç¬¬ä¸€ç±»æ–¹æ³•</h6><p>ä¸‹é¢æˆ‘ä»¬é¦–å…ˆä»ç¬¬ä¸€ç±»æ–¹æ³•å¼€å§‹è®¨è®ºï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•ï¼Œæ­¤å¤„åšäº†ç®€åŒ–ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">NSURLSessionDataTask</span> *)GET: parameters: success: failure: DEPRECATED_ATTRIBUTE</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">NSURLSessionDataTask</span> *)GET: parameters: progress: success: failure:</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">NSURLSessionDataTask</span> *)HEAD: parameters: success: failure:</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">NSURLSessionDataTask</span> *)POST: parameters: success: failure: DEPRECATED_ATTRIBUTE</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">NSURLSessionDataTask</span> *)POST: parameters: progress: success: failure:</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">NSURLSessionDataTask</span> *)PUT: parameters: success: failure:</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">NSURLSessionDataTask</span> *)PATCH: parameters: success: failure:</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">NSURLSessionDataTask</span> *)DELETE: parameters: success: failure:</span><br></pre></td></tr></table></figure>

<p>è¿™äº›æ–¹æ³•çš„å®ç°ç±»ä¼¼ï¼Œéƒ½æ˜¯è°ƒç”¨äº†åŒä¸€ä¸ªæ–¹æ³•åˆ›å»º taskï¼Œåªä¸è¿‡ä¼ å…¥çš„ method ä¸åŒè€Œå·²ï¼Œç„¶å resume è¿™ä¸ª taskã€‚å¦‚ä¸‹è¾¹çš„è¿™ä¸ª GET æ–¹æ³•æ‰€ç¤ºï¼Œå…¶ä»–æ–¹æ³•ï¼Œåªæ˜¯å°† GET æ¢æˆäº†å¯¹åº” POSTã€HEAD ç­‰ç­‰ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)GET:(<span class="built_in">NSString</span> *)URLString</span><br><span class="line">                   parameters:(<span class="type">id</span>)parameters</span><br><span class="line">                     progress:(<span class="type">void</span> (^)(<span class="built_in">NSProgress</span> * _Nonnull))downloadProgress</span><br><span class="line">                      success:(<span class="type">void</span> (^)(<span class="built_in">NSURLSessionDataTask</span> * _Nonnull, <span class="type">id</span> _Nullable))success</span><br><span class="line">                      failure:(<span class="type">void</span> (^)(<span class="built_in">NSURLSessionDataTask</span> * _Nullable, <span class="built_in">NSError</span> * _Nonnull))failure</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1.åˆ›å»ºä»»åŠ¡</span></span><br><span class="line">    <span class="built_in">NSURLSessionDataTask</span> *dataTask = [<span class="keyword">self</span> dataTaskWithHTTPMethod:<span class="string">@&quot;GET&quot;</span></span><br><span class="line">                                                        URLString:URLString</span><br><span class="line">                                                       parameters:parameters</span><br><span class="line">                                                   uploadProgress:<span class="literal">nil</span></span><br><span class="line">                                                 downloadProgress:downloadProgress</span><br><span class="line">                                                          success:success</span><br><span class="line">                                                          failure:failure];</span><br><span class="line">    <span class="comment">// 2.å¯åŠ¨ä»»åŠ¡</span></span><br><span class="line">    [dataTask resume];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dataTask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªåˆ›å»ºæ–¹æ³• dataTaskWithHTTPMethod: â€¦ æœ€ç»ˆåšäº† 2 ä»¶äº‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// *** æ„å»º NSURLSessionDataTask</span></span><br><span class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)dataTaskWithHTTPMethod:(<span class="built_in">NSString</span> *)method</span><br><span class="line">                                       URLString:(<span class="built_in">NSString</span> *)URLString</span><br><span class="line">                                      parameters:(<span class="type">id</span>)parameters</span><br><span class="line">                                  uploadProgress:(<span class="keyword">nullable</span> <span class="type">void</span> (^)(<span class="built_in">NSProgress</span> *uploadProgress)) uploadProgress</span><br><span class="line">                                downloadProgress:(<span class="keyword">nullable</span> <span class="type">void</span> (^)(<span class="built_in">NSProgress</span> *downloadProgress)) downloadProgress</span><br><span class="line">                                         success:(<span class="type">void</span> (^)(<span class="built_in">NSURLSessionDataTask</span> *, <span class="type">id</span>))success</span><br><span class="line">                                         failure:(<span class="type">void</span> (^)(<span class="built_in">NSURLSessionDataTask</span> *, <span class="built_in">NSError</span> *))failure</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. æ„å»º NSMutableURLRequestï¼Œå®é™…è°ƒç”¨ requestSerializer ä¸­åˆ›å»º request çš„æ–¹æ³•</span></span><br><span class="line">    <span class="comment">// å› ä¸º NSURLRequest çš„å±æ€§éƒ½æ˜¯ readonlyï¼Œæ‰€ä»¥æ­¤å¤„æ„å»ºäº† NSMutableURLRequestã€‚</span></span><br><span class="line">    <span class="built_in">NSError</span> *serializationError = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSMutableURLRequest</span> *request = [<span class="keyword">self</span>.requestSerializer requestWithMethod:method</span><br><span class="line">                                                                   URLString:[[<span class="built_in">NSURL</span> URLWithString:URLString relativeToURL:<span class="keyword">self</span>.baseURL] absoluteString]</span><br><span class="line">                                                                  parameters:parameters</span><br><span class="line">                                                                       error:&amp;serializationError];</span><br><span class="line">    <span class="comment">// æ„å»ºå¤±è´¥çš„å¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> (serializationError) &#123;</span><br><span class="line">        <span class="keyword">if</span> (failure) &#123;</span><br><span class="line">            <span class="built_in">dispatch_async</span>(<span class="keyword">self</span>.completionQueue ?: dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                failure(<span class="literal">nil</span>, serializationError);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. æ„å»º NSURLSessionDataTaskï¼šå®é™…è°ƒç”¨çˆ¶ç±» AFURLSessionManager çš„æ–¹æ³•</span></span><br><span class="line">    __block <span class="built_in">NSURLSessionDataTask</span> *dataTask = <span class="literal">nil</span>;</span><br><span class="line">    dataTask = [<span class="keyword">self</span> dataTaskWithRequest:request</span><br><span class="line">                          uploadProgress:uploadProgress</span><br><span class="line">                        downloadProgress:downloadProgress</span><br><span class="line">                       completionHandler:^(<span class="built_in">NSURLResponse</span> * __unused response, <span class="type">id</span> responseObject, <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">                           <span class="keyword">if</span> (error) &#123;</span><br><span class="line">                               <span class="keyword">if</span> (failure) &#123;</span><br><span class="line">                                   failure(dataTask, error);</span><br><span class="line">                               &#125;</span><br><span class="line">                           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                               <span class="keyword">if</span> (success) &#123;</span><br><span class="line">                                   success(dataTask, responseObject);</span><br><span class="line">                               &#125;</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> dataTask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.è°ƒç”¨ AFHTTPRequestSerializer çš„ requestWithMethod: URLString: parameters: error: æ–¹æ³•åˆ›å»º mutableURLRequestï¼›</p>
<p>2.åˆ©ç”¨ çˆ¶ç±»å³ AFURLSessionManager çš„ dataTaskWithRequest: uploadProgress: downloadProgress: completionHandler: åˆ›å»º taskï¼ˆéœ€è¦ä¸Šä¸€æ­¥å¾—åˆ°çš„ mutableURLRequest åšå‚æ•°ï¼‰ã€‚</p>
<p>AFHTTPRequestSerializer ä¸­çš„æ–¹æ³•ä¸»è¦åšäº†ä¸€äº›æ‹¼æ¥å‚æ•°åŠç¼–ç çš„å·¥ä½œï¼Œç•™å¾…<a href="">ä¸‹ä¸€ç¯‡</a>ä»‹ç»ã€‚è¿™é‡Œæ¥çœ‹çœ‹ AFURLSessionManager ä¸­çš„æ–¹æ³•ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)dataTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                               uploadProgress:(<span class="keyword">nullable</span> <span class="type">void</span> (^)(<span class="built_in">NSProgress</span> *uploadProgress)) uploadProgressBlock</span><br><span class="line">                             downloadProgress:(<span class="keyword">nullable</span> <span class="type">void</span> (^)(<span class="built_in">NSProgress</span> *downloadProgress)) downloadProgressBlock</span><br><span class="line">                            completionHandler:(<span class="keyword">nullable</span> <span class="type">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="type">id</span> _Nullable responseObject,  <span class="built_in">NSError</span> * _Nullable error))completionHandler &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.åˆ›å»ºTask(åŒæ—¶ä¿®å¤iOS8ä»¥ä¸‹ç³»ç»Ÿå‡ºç°çš„Bug)</span></span><br><span class="line">    __block <span class="built_in">NSURLSessionDataTask</span> *dataTask = <span class="literal">nil</span>;</span><br><span class="line">    url_session_manager_create_task_safely(^&#123;</span><br><span class="line">        dataTask = [<span class="keyword">self</span>.session dataTaskWithRequest:request];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.ä¸º task æ·»åŠ ä»£ç†</span></span><br><span class="line">[<span class="keyword">self</span> addDelegateForDataTask:dataTask</span><br><span class="line">              uploadProgress:uploadProgressBlock</span><br><span class="line">            downloadProgress:downloadProgressBlock</span><br><span class="line">           completionHandler:completionHandler];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dataTask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¹Ÿåšäº† 2 ä»¶äº‹ï¼Œè§ä¸Šè¾¹æ³¨é‡Šï¼Œä¸è¿‡ï¼Œåˆ›å»º dataTask çš„æ—¶å€™ä½¿ç”¨äº†ä¸€ä¸ª blockï¼Œç‚¹å¼€å®šä¹‰å‘ç°ï¼Œå½“ iOS ç³»ç»Ÿç‰ˆæœ¬  ï¼œ 8.0 æ—¶ï¼Œåˆ›å»ºäº†ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—æ¥æ‰§è¡Œ block ä¸­çš„ä»»åŠ¡ã€‚</p>
<p>è¿™æ˜¯ä¸ºäº†é˜²æ­¢ iOS8 ä»¥å‰çš„ç‰ˆæœ¬åœ¨å¹¶å‘é˜Ÿåˆ—ä¸Šåˆ›å»ºä»»åŠ¡æ—¶ï¼Œå¯èƒ½ä¼šè°ƒç”¨é”™è¯¯çš„ completionHandlersã€‚å½“ä»»åŠ¡è¿”å›ä¸€ä¸ªé‡å¤çš„ taskIdentifier æ—¶ï¼Œå…ˆå‰çš„ completionHandler è¢«æ¸…é™¤å¹¶æ›¿æ¢ä¸ºæ–°çš„ã€‚ å¦‚æœç¬¬ä¸€ä¸ªè¯·æ±‚çš„æ•°æ®åœ¨ç¬¬äºŒä¸ªè¯·æ±‚çš„æ•°æ®ä¹‹å‰è¿”å›ï¼Œé‚£ä¹ˆå°†é’ˆå¯¹ç¬¬äºŒä¸ª completionHandler è°ƒç”¨ç¬¬ä¸€ä¸ªå“åº”ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">void</span> url_session_manager_create_task_safely(dispatch_block_t block) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">NSFoundationVersionNumber</span> &lt; <span class="built_in">NSFoundationVersionNumber_With_Fixed_5871104061079552_bug</span>) &#123;</span><br><span class="line">        <span class="comment">// Fix of bug</span></span><br><span class="line">        <span class="comment">// Open Radar:http://openradar.appspot.com/radar?id=5871104061079552 (status: Fixed in iOS8)</span></span><br><span class="line">        <span class="comment">// Issue about:https://github.com/AFNetworking/AFNetworking/issues/2093</span></span><br><span class="line">        <span class="built_in">dispatch_sync</span>(url_session_manager_creation_queue(), block);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        block();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">dispatch_queue_t</span> url_session_manager_processing_queue() &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_queue_t</span> af_url_session_manager_processing_queue;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        af_url_session_manager_processing_queue = dispatch_queue_create(<span class="string">&quot;com.alamofire.networking.session.manager.processing&quot;</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> af_url_session_manager_processing_queue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="ç¬¬äºŒç±»æ–¹æ³•"><a href="#ç¬¬äºŒç±»æ–¹æ³•" class="headerlink" title="ç¬¬äºŒç±»æ–¹æ³•"></a>ç¬¬äºŒç±»æ–¹æ³•</h6><p>ç¬¬äºŒç±»æ–¹æ³•æœ€ç»ˆè°ƒç”¨çš„åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)POST:(<span class="built_in">NSString</span> *)URLString</span><br><span class="line">                    parameters:(<span class="type">id</span>)parameters</span><br><span class="line">     constructingBodyWithBlock:(<span class="type">void</span> (^)(<span class="type">id</span> &lt;AFMultipartFormData&gt; formData))block</span><br><span class="line">                      progress:(<span class="keyword">nullable</span> <span class="type">void</span> (^)(<span class="built_in">NSProgress</span> * _Nonnull))uploadProgress</span><br><span class="line">                       success:(<span class="type">void</span> (^)(<span class="built_in">NSURLSessionDataTask</span> *task, <span class="type">id</span> responseObject))success</span><br><span class="line">                       failure:(<span class="type">void</span> (^)(<span class="built_in">NSURLSessionDataTask</span> *task, <span class="built_in">NSError</span> *error))failure</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1.åˆ›å»º request</span></span><br><span class="line">    <span class="built_in">NSError</span> *serializationError = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSMutableURLRequest</span> *request = [<span class="keyword">self</span>.requestSerializer multipartFormRequestWithMethod:<span class="string">@&quot;POST&quot;</span> URLString:[[<span class="built_in">NSURL</span> URLWithString:URLString relativeToURL:<span class="keyword">self</span>.baseURL] absoluteString] parameters:parameters constructingBodyWithBlock:block error:&amp;serializationError];</span><br><span class="line">    <span class="keyword">if</span> (serializationError) &#123;</span><br><span class="line">        <span class="keyword">if</span> (failure) &#123;</span><br><span class="line">            <span class="built_in">dispatch_async</span>(<span class="keyword">self</span>.completionQueue ?: dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                failure(<span class="literal">nil</span>, serializationError);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.åˆ›å»º task</span></span><br><span class="line">    __block <span class="built_in">NSURLSessionDataTask</span> *task = [<span class="keyword">self</span> uploadTaskWithStreamedRequest:request progress:uploadProgress completionHandler:^(<span class="built_in">NSURLResponse</span> * __unused response, <span class="type">id</span> responseObject, <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">        <span class="keyword">if</span> (error) &#123;</span><br><span class="line">            <span class="keyword">if</span> (failure) &#123;</span><br><span class="line">                failure(task, error);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (success) &#123;</span><br><span class="line">                success(task, responseObject);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.å¯åŠ¨ä»»åŠ¡</span></span><br><span class="line">    [task resume];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> task;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŸºæœ¬æ­¥éª¤ä¸ç¬¬ä¸€ç±»æ–¹æ³•ç±»ä¼¼ï¼Œåªä¸è¿‡åˆ›å»º request å’Œ task çš„æ–¹æ³•ä¸ä¸€æ ·ï¼Œå¯¹äº request çš„åˆ›å»ºæ–¹æ³•ç•™å¾…<a href="">ä¸‹ä¸€ç¯‡</a>ä»‹ç»ï¼Œè¿™é‡Œæˆ‘ä»¬çœ‹çœ‹åˆ›å»º dataTask çš„æ–¹æ³•æœ‰ä»€ä¹ˆä¸åŒã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSURLSessionUploadTask</span> *)uploadTaskWithStreamedRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                                                 progress:(<span class="type">void</span> (^)(<span class="built_in">NSProgress</span> *uploadProgress)) uploadProgressBlock</span><br><span class="line">                                        completionHandler:(<span class="type">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="type">id</span> responseObject, <span class="built_in">NSError</span> *error))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    __block <span class="built_in">NSURLSessionUploadTask</span> *uploadTask = <span class="literal">nil</span>;</span><br><span class="line">    url_session_manager_create_task_safely(^&#123;</span><br><span class="line">        uploadTask = [<span class="keyword">self</span>.session uploadTaskWithStreamedRequest:request];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> addDelegateForUploadTask:uploadTask progress:uploadProgressBlock completionHandler:completionHandler];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> uploadTask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŸæ¥æ˜¯å…¶ä¸­åˆ›å»º task çš„æ–¹æ³• uploadTaskWithStreamedRequest: ä¸åŒï¼Œç”Ÿæˆçš„æ˜¯ NSURLSessionUploadTask ç±»å‹ï¼Œä¹‹åè®¾ç½®ä»£ç†çš„æ–¹æ³•ä¸ç¬¬ä¸€ç±»æ–¹æ³•ç±»ä¼¼ã€‚</p>
<p>æ³¨æ„ï¼šå…¶å®ç†è®ºä¸Šåº”è¯¥è¿˜æœ‰ç¬¬ 3 ç±»è¯·æ±‚æ–¹æ³•ï¼Œå³ä¸‹è½½çš„è¯·æ±‚ï¼Œä¸è¿‡ AFHTTPSessionManager é‡Œè¾¹å¹¶æœªå°è£…ï¼Œè€Œåªæ˜¯åœ¨å®ƒçš„çˆ¶ç±»é‡Œè¾¹æä¾›äº†åˆ›å»º downloadTask çš„æ–¹æ³•ï¼Œæ¯”å¦‚ä¸‹è¾¹çš„ã€‚ä¹Ÿæ˜¯åˆ›å»º task ä½¿ç”¨çš„ç³»ç»Ÿæ–¹æ³•ä¸åŒï¼Œå…¶ä»–ç±»ä¼¼ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                                             progress:(<span class="type">void</span> (^)(<span class="built_in">NSProgress</span> *downloadProgress)) downloadProgressBlock</span><br><span class="line">                                          destination:(<span class="built_in">NSURL</span> * (^)(<span class="built_in">NSURL</span> *targetPath, <span class="built_in">NSURLResponse</span> *response))destination</span><br><span class="line">                                    completionHandler:(<span class="type">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSURL</span> *filePath, <span class="built_in">NSError</span> *error))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    __block <span class="built_in">NSURLSessionDownloadTask</span> *downloadTask = <span class="literal">nil</span>;</span><br><span class="line">    url_session_manager_create_task_safely(^&#123;</span><br><span class="line">        downloadTask = [<span class="keyword">self</span>.session downloadTaskWithRequest:request];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> addDelegateForDownloadTask:downloadTask progress:downloadProgressBlock destination:destination completionHandler:completionHandler];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> downloadTask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨åˆ†åˆ«ä»‹ç»å®Œäº† 2 ç±»å‘é€è¯·æ±‚çš„æ–¹æ³•ï¼Œä¸‹è¾¹æˆ‘ä»¬çœ‹çœ‹ä¸º task æ·»åŠ ä»£ç†çš„æ–¹æ³•ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)addDelegateForDataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask</span><br><span class="line">                uploadProgress:(<span class="keyword">nullable</span> <span class="type">void</span> (^)(<span class="built_in">NSProgress</span> *uploadProgress)) uploadProgressBlock</span><br><span class="line">              downloadProgress:(<span class="keyword">nullable</span> <span class="type">void</span> (^)(<span class="built_in">NSProgress</span> *downloadProgress)) downloadProgressBlock</span><br><span class="line">             completionHandler:(<span class="type">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="type">id</span> responseObject, <span class="built_in">NSError</span> *error))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    AFURLSessionManagerTaskDelegate *delegate = [[AFURLSessionManagerTaskDelegate alloc] initWithTask:dataTask];</span><br><span class="line">    delegate.manager = <span class="keyword">self</span>;</span><br><span class="line">    delegate.completionHandler = completionHandler;</span><br><span class="line"></span><br><span class="line">    dataTask.taskDescription = <span class="keyword">self</span>.taskDescriptionForSessionTasks;</span><br><span class="line">    <span class="comment">// ä¿å­˜ task å’Œ delegate çš„æ˜ å°„å…³ç³»ï¼Œå¹¶æ·»åŠ å¯¹ä»»åŠ¡å¼€å§‹å’Œæš‚åœçš„ç›‘å¬</span></span><br><span class="line">    [<span class="keyword">self</span> setDelegate:delegate forTask:dataTask];</span><br><span class="line"></span><br><span class="line">    delegate.uploadProgressBlock = uploadProgressBlock;</span><br><span class="line">    delegate.downloadProgressBlock = downloadProgressBlock;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼ˆAFURLSessionManagerTaskDelegateï¼‰ï¼Œåœ¨è¿™ä¸ª task ä¸­å¯¹è¯·æ±‚è¿‡ç¨‹è¿›è¡Œå¤„ç†ï¼›è®¾ç½®å®Œä»£ç†çš„å±æ€§ä¹‹åï¼Œæ‰è°ƒç”¨ setDelegate: forTask: æ–¹æ³•æ¥ä¸º task åŠä»£ç†æ·»åŠ å…³è”ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)setDelegate:(AFURLSessionManagerTaskDelegate *)delegate</span><br><span class="line">            forTask:(<span class="built_in">NSURLSessionTask</span> *)task</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(task);</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(delegate);</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span>.lock lock];</span><br><span class="line">    <span class="comment">// ä»¥ taskIdentifier ä¸º keyï¼Œå°† delegate å­˜å‚¨åœ¨ä¸€ä¸ªå­—å…¸(self.mutableTaskDelegatesKeyedByTaskIdentifier)é‡Œ</span></span><br><span class="line">    <span class="keyword">self</span>.mutableTaskDelegatesKeyedByTaskIdentifier[@(task.taskIdentifier)] = delegate;</span><br><span class="line">    <span class="comment">// æ·»åŠ å¯¹ä»»åŠ¡å¼€å§‹å’Œæš‚åœçš„ç›‘å¬</span></span><br><span class="line">    [<span class="keyword">self</span> addNotificationObserverForTask:task];</span><br><span class="line">    [<span class="keyword">self</span>.lock unlock];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸»è¦å°±æ˜¯ä¿å­˜ task å’Œ ä»£ç†ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œä¿å­˜åœ¨ä¹‹å‰å·²ç»åˆ›å»ºå¥½çš„å­—å…¸ mutableTaskDelegatesKeyedByTaskIdentifier é‡Œè¾¹ï¼Œå¹¶ä¸º task æ·»åŠ é€šçŸ¥ï¼Œç›‘å¬äº† task resume å’Œ suspend ä¸¤ä¸ªçŠ¶æ€ã€‚ç„¶åæˆ‘ä»¬å‘ç°å½“çŠ¶æ€å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼Œå®é™…ä¸Šåªæ˜¯åœ¨ä¸»é˜Ÿåˆ—åˆå‘é€äº† 2 ä¸­é€šçŸ¥ï¼Œåªæ˜¯æ”¹äº†ä¸ªåå­—è€Œå·²ã€‚å…¨å±€æœç´¢æ–°çš„é€šçŸ¥ååå‘ç°ï¼Œåªæœ‰åœ¨ UIKit é‚£ä¸ªç›®å½•ä¸‹çš„ç±»é‡Œè¾¹æ‰ä¼šç”¨åˆ°ã€‚</p>
<p>ç„¶åçœ‹çœ‹ä»£ç†ç±» AFURLSessionManagerTaskDelegateï¼Œä»ä»–çš„åˆå§‹åŒ–æ–¹æ³•å¼€å§‹ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithTask:(<span class="built_in">NSURLSessionTask</span> *)task &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="variable language_">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1.å­˜æ”¾ä¸‹è½½çš„æ•°æ®</span></span><br><span class="line">    _mutableData = [<span class="built_in">NSMutableData</span> data];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//  2.åˆ›å»ºå¹¶åˆå§‹åŒ–ä¸Šä¼ åŠä¸‹è½½è¿›åº¦ _uploadProgress å’Œ _downloadProgress</span></span><br><span class="line">   _uploadProgress = [[<span class="built_in">NSProgress</span> alloc] initWithParent:<span class="literal">nil</span> userInfo:<span class="literal">nil</span>];</span><br><span class="line">    _downloadProgress = [[<span class="built_in">NSProgress</span> alloc] initWithParent:<span class="literal">nil</span> userInfo:<span class="literal">nil</span>];</span><br><span class="line">    </span><br><span class="line">    __<span class="keyword">weak</span> __typeof__(task) weakTask = task;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSProgress</span> *progress <span class="keyword">in</span> @[ _uploadProgress, _downloadProgress ])</span><br><span class="line">    &#123;</span><br><span class="line">        progress.totalUnitCount = <span class="built_in">NSURLSessionTransferSizeUnknown</span>;</span><br><span class="line">        </span><br><span class="line">        progress.cancellable = <span class="literal">YES</span>; <span class="comment">// å¯ä»¥å–æ¶ˆ</span></span><br><span class="line">        progress.cancellationHandler = ^&#123;</span><br><span class="line">            [weakTask cancel];</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        progress.pausable = <span class="literal">YES</span>; <span class="comment">// å¯ä»¥æš‚åœ</span></span><br><span class="line">        progress.pausingHandler = ^&#123;</span><br><span class="line">            [weakTask suspend];</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ¢å¤</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> AF_CAN_USE_AT_AVAILABLE</span></span><br><span class="line">        <span class="keyword">if</span> (@available(iOS <span class="number">9</span>, macOS <span class="number">10.11</span>, *))</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="keyword">if</span> ([progress respondsToSelector:<span class="keyword">@selector</span>(setResumingHandler:)])</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#123;</span><br><span class="line">            progress.resumingHandler = ^&#123;</span><br><span class="line">                [weakTask resume];</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç»™ progress æ·»åŠ ç›‘å¬</span></span><br><span class="line">        [progress addObserver:<span class="keyword">self</span></span><br><span class="line">                   forKeyPath:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(fractionCompleted))</span><br><span class="line">                      options:<span class="built_in">NSKeyValueObservingOptionNew</span></span><br><span class="line">                      context:<span class="literal">NULL</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šè¾¹çš„ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œå°±åšäº† 2 ä»¶äº‹ï¼š</p>
<ul>
<li>åˆ›å»ºå­˜æ”¾ä¸‹è½½çš„æ•°æ®çš„å¯å˜æ•°ç»„ _mutableDataï¼›</li>
<li>åˆ›å»ºç”¨äºå­˜å‚¨ä¸Šä¼ åŠä¸‹è½½è¿›åº¦çš„å¯¹è±¡ _uploadProgress å’Œ _downloadProgressï¼Œå¹¶ä¸ºå…¶æ·»åŠ  KVO ç›‘å¬ã€‚<br>æŸ¥çœ‹äº† KVO å¯¹åº”çš„ <code>observeValueForKeyPath:</code> æ–¹æ³•å®ç°åï¼Œå‘ç°åªæ˜¯å°†æœ€æ–°çš„ä¸‹è½½æˆ–ä¸Šä¼ è¿›åº¦å›ä¼ ç»™äº†å¯¹åº”çš„ blockã€‚å½“ç„¶ï¼Œä¼šåœ¨ dealloc æ–¹æ³•ä¸­ç§»é™¤ç›‘å¬ï¼Œå¦åˆ™ä¼š Crashã€‚</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="type">id</span>)object change:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *,<span class="type">id</span>&gt; *)change context:(<span class="type">void</span> *)context &#123;</span><br><span class="line">    </span><br><span class="line">   <span class="keyword">if</span> ([object isEqual:<span class="keyword">self</span>.downloadProgress]) &#123; <span class="comment">// ä¸‹è½½è¿›åº¦</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.downloadProgressBlock) &#123;</span><br><span class="line">            <span class="keyword">self</span>.downloadProgressBlock(object);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ([object isEqual:<span class="keyword">self</span>.uploadProgress]) &#123; <span class="comment">// ä¸Šä¼ è¿›åº¦</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.uploadProgressBlock) &#123;</span><br><span class="line">            <span class="keyword">self</span>.uploadProgressBlock(object);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥å°±æ˜¯ä¸€äº›ä»£ç†æ–¹æ³•äº†ï¼Œä»–ä»¬éƒ½æ˜¯ä» AFURLSessionManager é‡Œè¾¹çš„ä»£ç†æ–¹æ³•è½¬å‘è¿‡æ¥çš„ï¼Œåè¾¹å†ä½œä»‹ç»å§ã€‚</p>
<p>å›åˆ° AFURLSessionManager.m ä¸­ï¼Œå‰è¾¹éƒ½æ˜¯åœ¨è¯·æ±‚å‘é€ä¹‹å‰åšçš„å‡†å¤‡å·¥ä½œï¼Œç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹å‘èµ·è¯·æ±‚ä¹‹åçš„æƒ…å†µï¼Œå½“ç„¶æ˜¯çœ‹ä»£ç†æ–¹æ³•äº†ã€‚</p>
<h5 id="ä»£ç†æ–¹æ³•"><a href="#ä»£ç†æ–¹æ³•" class="headerlink" title="ä»£ç†æ–¹æ³•"></a>ä»£ç†æ–¹æ³•</h5><p>è¿™é‡Œçš„ 15 ä¸ªä»£ç†æ–¹æ³•åˆ†å± 4 ä¸ªä¸åŒçš„åè®®ï¼š<br><code>NSURLSessionDelegate</code><br><code>NSURLSessionTaskDelegate</code><br><code>NSURLSessionDataDelegate</code><br><code>NSURLSessionDownloadDelegate</code></p>
<p>æˆ‘ä»¬ä¾æ¬¡çœ‹çœ‹å…¶ä¸­å®ç°çš„åè®®æ–¹æ³•ï¼š</p>
<h5 id="NSURLSessionDelegate"><a href="#NSURLSessionDelegate" class="headerlink" title="NSURLSessionDelegate"></a>NSURLSessionDelegate</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å½“ session å¤±æ•ˆæ—¶è°ƒç”¨</span></span><br><span class="line">- (<span class="type">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</span><br><span class="line">didBecomeInvalidWithError:(<span class="built_in">NSError</span> *)error</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.sessionDidBecomeInvalid) &#123;</span><br><span class="line">        <span class="keyword">self</span>.sessionDidBecomeInvalid(session, error);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:AFURLSessionDidInvalidateNotification object:session];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚ä½•æ¥å—æˆæƒæŒ‘æˆ˜ï¼Œå¦‚æœæ­¤æ–¹æ³•æœªå®ç°ï¼Œä¼šè°ƒç”¨åè¾¹ NSURLSessionTaskDelegate ä¸­çš„ç¬¬ä¸€ä¸ªä»£ç†æ–¹æ³• URLSession:task:willPerformHTTPRedirection:newRequest:completionHandler:</span></span><br><span class="line">- (<span class="type">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</span><br><span class="line">didReceiveChallenge:(<span class="built_in">NSURLAuthenticationChallenge</span> *)challenge</span><br><span class="line"> completionHandler:(<span class="type">void</span> (^)(<span class="built_in">NSURLSessionAuthChallengeDisposition</span> disposition, <span class="built_in">NSURLCredential</span> *credential))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSURLSessionAuthChallengeDisposition</span> disposition = <span class="built_in">NSURLSessionAuthChallengePerformDefaultHandling</span>;</span><br><span class="line">    __block <span class="built_in">NSURLCredential</span> *credential = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  1.åˆ¤æ–­æœ‰æ²¡æœ‰è‡ªå®šä¹‰ block: sessionDidReceiveAuthenticationChallenge</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.sessionDidReceiveAuthenticationChallenge) &#123;</span><br><span class="line">        disposition = <span class="keyword">self</span>.sessionDidReceiveAuthenticationChallenge(session, challenge, &amp;credential);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//  2.å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰ blockï¼Œåˆ¤æ–­ å¦‚æœæœåŠ¡ç«¯è¦æ±‚çš„è®¤è¯æ–¹æ³•æ˜¯ä¸æ˜¯ NSURLAuthenticationMethodServerTrust</span></span><br><span class="line">        <span class="keyword">if</span> ([challenge.protectionSpace.authenticationMethod isEqualToString:<span class="built_in">NSURLAuthenticationMethodServerTrust</span>]) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//  3.åŸºäºå®¢æˆ·ç«¯çš„å®‰å…¨ç­–ç•¥æ¥å†³å®šæ˜¯å¦ä¿¡ä»»è¯¥æœåŠ¡å™¨</span></span><br><span class="line">            <span class="comment">// *** ç‚¹å¼€æ­¤æ–¹æ³•</span></span><br><span class="line">            <span class="keyword">if</span> ([<span class="keyword">self</span>.securityPolicy evaluateServerTrust:challenge.protectionSpace.serverTrust forDomain:challenge.protectionSpace.host]) &#123;</span><br><span class="line">                </span><br><span class="line">                credential = [<span class="built_in">NSURLCredential</span> credentialForTrust:challenge.protectionSpace.serverTrust];</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (credential) &#123;</span><br><span class="line">                    disposition = <span class="built_in">NSURLSessionAuthChallengeUseCredential</span>; <span class="comment">// ä½¿ç”¨è¯ä¹¦çš„ Challenge</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    disposition = <span class="built_in">NSURLSessionAuthChallengePerformDefaultHandling</span>; <span class="comment">// é»˜è®¤ Challenge</span></span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                disposition = <span class="built_in">NSURLSessionAuthChallengeCancelAuthenticationChallenge</span>; <span class="comment">// å–æ¶ˆ Challenge</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            disposition = <span class="built_in">NSURLSessionAuthChallengePerformDefaultHandling</span>; <span class="comment">// é»˜è®¤ Challenge</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// *** å»æ‰§è¡Œ iOS ç³»ç»Ÿçš„è®¤è¯æ–¹æ¡ˆ</span></span><br><span class="line">    <span class="keyword">if</span> (completionHandler) &#123;</span><br><span class="line">        completionHandler(disposition, credential);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹äºç¬¬ä¸€ä¸ªæ–¹æ³• <code>URLSession: didBecomeInvalidWithError: </code>ï¼Œå½“ session å¤±æ•ˆæ—¶è°ƒç”¨æ­¤æ–¹æ³•ã€‚å®˜æ–¹æ–‡æ¡£ç»™å‡ºçš„å…·ä½“è¯´æ˜æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬è°ƒç”¨äº† Â <code>finishTasksAndInvalidate</code> æ–¹æ³•ï¼Œåˆ™ä¼šç­‰åˆ° session é‡Œè¾¹æœ€åä¸€ä¸ª task æ‰§è¡Œå®Œï¼Œæ‰ä¼šè°ƒç”¨æ­¤ä»£ç†æ–¹æ³•ï¼›å¦‚æœè°ƒç”¨äº† <code>invalidateAndCancel</code> è¿™ä¸ªæ–¹æ³•ï¼Œåˆ™ä¼šç«‹å³æ‰§è¡Œè¯¥ä»£ç†æ–¹æ³•ã€‚</p>
<p>ç¬¬ 2 ä¸ªä»£ç†æ–¹æ³•æ˜¯å½“å®¢æˆ·ç«¯æ”¶åˆ° â€œæˆæƒæŒ‘æˆ˜â€ï¼ˆå§‘ä¸”è¿™ä¹ˆç¿»è¯‘å§ï¼Œè™½ç„¶å¾ˆåˆ«æ‰­ï¼‰ æ—¶å®è¡Œçš„æ–¹æ³•ï¼Œæµç¨‹å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e80abea104eb4724a835b824f5f40aed~tplv-k3u1fbpfcp-watermark.image" alt="AFNetWorking_Authentication_challenge.png"></p>
<ul>
<li><p>é¦–å…ˆï¼Œåˆ¤æ–­ç”¨æˆ·(ä½¿ç”¨è€…)æœ‰æ²¡æœ‰è‡ªå®šä¹‰ block: sessionDidReceiveAuthenticationChallengeï¼Œå¦‚æœæœ‰ï¼Œåˆ™æ‰§è¡Œè‡ªå®šä¹‰çš„ block å¤„ç†æŒ‘æˆ˜ï¼Œè¿”å›ä¸€ä¸ªæšä¸¾å€¼ç»™ <code>disposition</code>ï¼Œå¹¶ç»™ <code>credential</code> èµ‹å€¼ (å› ä¸ºå‚æ•°æ˜¯ &amp;credential) å¤„ç†ï¼Œä»–ä»¬éƒ½å°†ä½œä¸ºæœ€åä¸€æ­¥æ‰§è¡Œ completionhandler() æ—¶çš„å‚æ•°ã€‚å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰å¤„ç†æŒ‘æˆ˜çš„ blockï¼Œåˆ™æ¥ç€è¿›è¡Œä¸‹ä¸€æ­¥çš„åˆ¤æ–­ï¼› </p>
</li>
<li><p>ç„¶åï¼Œåˆ¤æ–­æœåŠ¡ç«¯è¦æ±‚çš„è®¤è¯æ–¹æ³•æ˜¯ä¸æ˜¯ NSURLAuthenticationMethodServerTrustã€‚å¦‚æœæ˜¯ï¼Œåˆ™åªéœ€è¦éªŒè¯æœåŠ¡ç«¯è¯ä¹¦æ˜¯å¦å®‰å…¨ï¼ˆå³ https çš„å•å‘è®¤è¯ï¼Œè¿™æ˜¯ AFNetworking é»˜è®¤å¤„ç†çš„è®¤è¯æ–¹å¼ï¼Œå…¶ä»–çš„è®¤è¯æ–¹å¼ï¼Œåªèƒ½é€šè¿‡å®šä¹‰ block æ¥å®ç°ï¼‰ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œè¿˜éœ€è¦åšä¸‹ä¸€æ­¥å¤„ç†ï¼›</p>
</li>
<li><p>æ¥ä¸‹æ¥ï¼Œæœ‰ä¸€ä¸ª if åˆ¤æ–­ï¼Œæ¡ä»¶æ˜¯ <code>securityPolicy</code> è°ƒç”¨ <code>evaluateServerTrust: forDomain:</code> æ–¹æ³•çš„æ‰§è¡Œç»“æœï¼Œè¯¥æ–¹æ³•å®é™…æ˜¯ AFNetWorking è‡ªå·±å¯¹å…ˆåšçš„ä¸€æ¬¡ HTTPS è®¤è¯ï¼Œè¿”å›ç»“æœè¡¨æ˜è¯¥æœåŠ¡å™¨æ˜¯å¦å¯ä»¥ä¿¡ä»»ï¼Œå…·ä½“æ–¹æ³•å®ç°è§<a href="">ä¸‹ä¸€ç¯‡</a>ã€‚</p>
<ul>
<li>å¦‚æœ if æ¡ä»¶æˆç«‹ï¼Œå³ AFNetworking è®¤ä¸ºæœåŠ¡å™¨å¯ä¿¡ä»»ï¼Œæ‰§è¡Œ <code>NSURLCredential</code> çš„ç³»ç»Ÿæ–¹æ³• <code>credentialForTrust:</code> ç”Ÿæˆä¸€ä¸ªå‡­è¯æˆ–ç§°è¯ä¹¦ <code>credential</code>ï¼Œå¦‚æœæˆåŠŸç”Ÿæˆï¼Œå°±ç»™ <code>disposition</code> èµ‹ç›¸åº”çš„å€¼ã€‚</li>
<li>å¦‚æœ if æ¡ä»¶ä¸æˆç«‹ï¼Œåˆ™å–æ¶ˆè®¤è¯ã€‚</li>
</ul>
</li>
<li><p>æœ€åï¼Œæ‰§è¡Œ <code>completionHandler(disposition, credential)</code>ï¼Œå…¶ä¸­ï¼Œ<code>credential</code> æ˜¯æ ¹æ®æœåŠ¡ç«¯è¿”å›çš„è¯ä¹¦åŠç›¸å…³ä¿¡æ¯ç”Ÿæˆçš„ç”¨äºå®¢æˆ·ç«¯éªŒè¯çš„å¯¹è±¡ï¼›<code>disposition</code> å°±æ˜¯ä¸€ä¸ªæšä¸¾å€¼ï¼ˆå¸¸é‡ï¼‰ï¼Œç”¨äºè¯´æ˜åº”è¯¥ä»¥ä½•ç§æ–¹å¼å¤„ç†å‡­è¯ <code>credential</code>ã€‚</p>
</li>
</ul>
<h5 id="NSURLSessionTaskDelegate"><a href="#NSURLSessionTaskDelegate" class="headerlink" title="NSURLSessionTaskDelegate"></a>NSURLSessionTaskDelegate</h5><p>è¿™é‡Œä»¥å…¸å‹çš„è¯·æ±‚ç»“æŸçš„ä»£ç†æ–¹æ³•ä¸ºä¾‹åšä¸€ä¸ªç®€å•ä»‹ç»ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</span><br><span class="line">              task:(<span class="built_in">NSURLSessionTask</span> *)task</span><br><span class="line">didCompleteWithError:(<span class="built_in">NSError</span> *)error</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// å–å‡º task å¯¹åº”çš„ delegate</span></span><br><span class="line">    AFURLSessionManagerTaskDelegate *delegate = [<span class="keyword">self</span> delegateForTask:task];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯åœ¨åå°å®Œæˆçš„ä»»åŠ¡ï¼Œåˆ™æ­¤å¤„ delegate ä¸º nilã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (delegate) &#123;</span><br><span class="line">        [delegate URLSession:session task:task didCompleteWithError:error];</span><br><span class="line">        [<span class="keyword">self</span> removeDelegateForTask:task];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰§è¡Œ block</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.taskDidComplete) &#123;</span><br><span class="line">        <span class="keyword">self</span>.taskDidComplete(session, task, error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯åœ¨è¯·æ±‚ç»“æŸæ—¶æ‰§è¡Œçš„ä»£ç†æ–¹æ³•ï¼ˆå¯èƒ½æˆåŠŸæˆ–è€…å¤±è´¥ï¼Œå¦‚æœå¤±è´¥ï¼Œerroræœ‰å€¼ï¼‰ï¼Œè°ƒç”¨è‡ªå·±çš„ <code>delegateForTask:</code> æ–¹æ³•ï¼Œå–å‡º task å¯¹åº”çš„ delegateï¼Œå¦‚æœå–åˆ°äº†ï¼Œåˆ™æ‰§è¡Œ delegate çš„ <code>URLSession: task: didCompleteWithError:</code> æ–¹æ³•ã€‚</p>
<p>æ³¨æ„ï¼Œå®é™…æˆ‘ä»¬æœ€å¼€å§‹ä¼ åˆ° GETã€POST ç­‰æ–¹æ³•ä¸­çš„ block éƒ½æ˜¯èµ‹å€¼ç»™äº†å¯¹åº” task çš„ delegateï¼Œæ‰€ä»¥çœŸæ­£æ‰§è¡Œé‚£äº› block ä¹Ÿæ˜¯åœ¨è½¬å‘åˆ°çš„ delegate(AFURLSessionManagerTaskDelegate) çš„å¯¹åº”ä»£ç†æ–¹æ³•ä¸­ï¼Œè€Œä¸æ˜¯ä¸Šè¾¹ä»£ç æœ€åçš„ blockã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)URLSession:(__unused <span class="built_in">NSURLSession</span> *)session</span><br><span class="line">              task:(<span class="built_in">NSURLSessionTask</span> *)task</span><br><span class="line">didCompleteWithError:(<span class="built_in">NSError</span> *)error</span><br><span class="line">&#123;</span><br><span class="line">    __<span class="keyword">strong</span> AFURLSessionManager *manager = <span class="keyword">self</span>.manager;</span><br><span class="line"></span><br><span class="line">    __block <span class="type">id</span> responseObject = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    __block <span class="built_in">NSMutableDictionary</span> *userInfo = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">    userInfo[AFNetworkingTaskDidCompleteResponseSerializerKey] = manager.responseSerializer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Performance Improvement from #2672</span></span><br><span class="line">    <span class="built_in">NSData</span> *data = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.mutableData) &#123;</span><br><span class="line">        data = [<span class="keyword">self</span>.mutableData <span class="keyword">copy</span>];</span><br><span class="line">        <span class="comment">//We no longer need the reference, so nil it out to gain back some memory.</span></span><br><span class="line">        <span class="keyword">self</span>.mutableData = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.downloadFileURL) &#123;</span><br><span class="line">        userInfo[AFNetworkingTaskDidCompleteAssetPathKey] = <span class="keyword">self</span>.downloadFileURL;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data) &#123;</span><br><span class="line">        userInfo[AFNetworkingTaskDidCompleteResponseDataKey] = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (error) &#123;    <span class="comment">// å‡ºé”™çš„æ—¶å€™</span></span><br><span class="line">        </span><br><span class="line">        userInfo[AFNetworkingTaskDidCompleteErrorKey] = error;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‡ºé”™æ—¶ï¼Œæ‰§è¡Œå®Œæˆçš„å›è°ƒ åŠ å‘é€ä»»åŠ¡ç»“æŸçš„é€šçŸ¥</span></span><br><span class="line">        dispatch_group_async(manager.completionGroup ?: url_session_manager_completion_group(), manager.completionQueue ?: dispatch_get_main_queue(), ^&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">self</span>.completionHandler) &#123;</span><br><span class="line">                <span class="keyword">self</span>.completionHandler(task.response, responseObject, error);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                [[<span class="built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:AFNetworkingTaskDidCompleteNotification object:task userInfo:userInfo];</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;    <span class="comment">// æ­£å¸¸ç»“æŸçš„æ—¶å€™</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">dispatch_async</span>(url_session_manager_processing_queue(), ^&#123;</span><br><span class="line">            <span class="built_in">NSError</span> *serializationError = <span class="literal">nil</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// *** ä½¿ç”¨ responseSerializer å¤„ç†è¿”å›ç»“æœ</span></span><br><span class="line">            responseObject = [manager.responseSerializer responseObjectForResponse:task.response data:data error:&amp;serializationError];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">self</span>.downloadFileURL) &#123;</span><br><span class="line">                responseObject = <span class="keyword">self</span>.downloadFileURL;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (responseObject) &#123;</span><br><span class="line">                userInfo[AFNetworkingTaskDidCompleteSerializedResponseKey] = responseObject;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (serializationError) &#123;</span><br><span class="line">                userInfo[AFNetworkingTaskDidCompleteErrorKey] = serializationError;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ­£å¸¸ç»“æŸçš„æ—¶å€™ï¼Œæ‰§è¡Œå®Œæˆçš„å›è°ƒ åŠ å‘é€ä»»åŠ¡ç»“æŸçš„é€šçŸ¥</span></span><br><span class="line">            dispatch_group_async(manager.completionGroup ?: url_session_manager_completion_group(), manager.completionQueue ?: dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">self</span>.completionHandler) &#123;</span><br><span class="line">                    <span class="keyword">self</span>.completionHandler(task.response, responseObject, serializationError);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:AFNetworkingTaskDidCompleteNotification object:task userInfo:userInfo];</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»”ç»†çœ‹äº†ä¸€ä¸‹ï¼Œè¿™ä¸ªæ–¹æ³•é‡Œè¾¹å°±ä¸»è¦å°±ä¸ºäº†åšäº†  2 ä»¶äº‹ï¼Œç¬¬ä¸€ä»¶æ˜¯æ‰§è¡Œ <code>self.completionHandler()</code>ï¼ŒåŒ…æ‹¬è¯·æ±‚ç»“æœçš„åºåˆ—åŒ–å°†ä¼šåœ¨<a href="">ä¸‹ä¸€ç¯‡</a>ä»‹ç»ï¼›ç¬¬äºŒä»¶æ˜¯å‘é€ä»»åŠ¡å®Œæˆçš„é€šçŸ¥ï¼ŒåŒ…æ‹¬æ„å»º userInfo è¿™ä¸ªå¯å˜å­—å…¸ï¼Œè¯¦è§ä»£ç ã€‚</p>
<p>è‡³äºå…¶ä»–åè®®åŠä»£ç†æ–¹æ³•ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯éµå¾ªå°†ä»£ç†æ–¹æ³•è½¬å‘ç»™ <code>AFURLSessionManagerTaskDelegate</code> é‡Œçš„å¯¹åº”æ–¹æ³•çš„é€»è¾‘ï¼Œé™äºç¯‡å¹…æš‚æ—¶å°±ä¸åšè®¨è®ºäº†ã€‚</p>
<h3 id="å½©è›‹"><a href="#å½©è›‹" class="headerlink" title="å½©è›‹"></a>å½©è›‹</h3><p>å¿½ç„¶æƒ³èµ·æ¥ï¼Œå…¶å® AFNetWorking çš„ readme.md é‡Œè¾¹ç»™çš„ 4 ä¸ªç¤ºä¾‹éƒ½æ˜¯ç›´æ¥ä½¿ç”¨ AFURLSessionManager è€Œä¸æ˜¯ä½¿ç”¨å®ƒçš„å­ç±» AFHTTPSessionManagerï¼Œéš¾é“æˆ‘åˆè¯´å¤šäº†ï¼Œå“ˆå“ˆã€‚</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a target="_blank" rel="noopener" href="http://www.saitjr.com/ios/ios-ns_unavailable-ns_designated_initializer.html">NS_UNAVAILABLE ä¸ NS_DESIGNATED_INITIALIZER</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/239084afda5c">è¿›åº¦: NSProgress</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://devhe.com/2019/02/23/AFNetWorking-Source-Learning-02/" data-id="cl7c2jebz0002lzfybyyu2y8y" data-title="AFNetWorking æºç å­¦ä¹ ç¬”è®° â˜ NSURLSession" class="article-share-link">Teilen</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/03/02/AFNetWorking-Source-Learning-03/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Neuer</strong>
      <div class="article-nav-title">
        
          AFNetWorking æºç å­¦ä¹ ç¬”è®° â˜ Security
        
      </div>
    </a>
  
  
    <a href="/2019/02/17/AFNetWorking-Source-Learning-01/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Ã„lter</strong>
      <div class="article-nav-title">AFNetWorking æºç å­¦ä¹ ç¬”è®° â˜ ä¸»ä½“æµç¨‹</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/08/24/ijkplayer-Compilation-and-Packaging/">ijkplayer ç¼–è¯‘-æ‰“åŒ…-Podæ”¯æŒ</a>
          </li>
        
          <li>
            <a href="/2022/08/23/Topics-and-mentions-similar-to-Weibo/">iOS UITextView å®ç°ç±»ä¼¼å¾®åšçš„è¯é¢˜ã€æåŠåŠŸèƒ½</a>
          </li>
        
          <li>
            <a href="/2019/04/10/MLeaksFinder-Source-Learning/">MLeaksFinder æºç å­¦ä¹ ç¬”è®°</a>
          </li>
        
          <li>
            <a href="/2019/03/17/AFNetWorking-Source-Learning-05/">AFNetWorking æºç å­¦ä¹ ç¬”è®° â˜ Reachability</a>
          </li>
        
          <li>
            <a href="/2019/03/10/AFNetWorking-Source-Learning-04/">AFNetWorking æºç å­¦ä¹ ç¬”è®° â˜ Serialization</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 He Hai<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>