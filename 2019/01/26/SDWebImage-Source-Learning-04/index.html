<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>SDWebImage æºç å­¦ä¹ ç¬”è®° â˜ SDWebImageDownloader | riversea2015</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="å‰è¨€è¿™æ˜¯æœ¬ç³»åˆ—çš„ç¬¬ 4 ç¯‡ï¼Œæœ¬ç¯‡å°†ä¸»è¦ä»‹ç» SDWebImageDownloader è¿™ä¸ªè´Ÿè´£ä¸‹è½½çš„ç±»ï¼Œå½“ç„¶è¿˜æœ‰ä¸€äº›ç›¸å…³ç±»åŠåè®®ï¼Œå¦‚ï¼š SDWebImageDownloadTokenã€SDWebImageDownloaderOperation å’Œ SDWebImageDownloaderOperationInterface ç­‰ã€‚ æ­£æ–‡å¼€å¯æ­£æ–‡æè¿°ä¹‹å‰ï¼Œä¾æ—§å…ˆçœ‹ 2 ä¸ªé‡è¦çš„æšä¸¾ï¼šSDWebIma">
<meta property="og:type" content="article">
<meta property="og:title" content="SDWebImage æºç å­¦ä¹ ç¬”è®° â˜ SDWebImageDownloader">
<meta property="og:url" content="https://devhe.com/2019/01/26/SDWebImage-Source-Learning-04/index.html">
<meta property="og:site_name" content="riversea2015">
<meta property="og:description" content="å‰è¨€è¿™æ˜¯æœ¬ç³»åˆ—çš„ç¬¬ 4 ç¯‡ï¼Œæœ¬ç¯‡å°†ä¸»è¦ä»‹ç» SDWebImageDownloader è¿™ä¸ªè´Ÿè´£ä¸‹è½½çš„ç±»ï¼Œå½“ç„¶è¿˜æœ‰ä¸€äº›ç›¸å…³ç±»åŠåè®®ï¼Œå¦‚ï¼š SDWebImageDownloadTokenã€SDWebImageDownloaderOperation å’Œ SDWebImageDownloaderOperationInterface ç­‰ã€‚ æ­£æ–‡å¼€å¯æ­£æ–‡æè¿°ä¹‹å‰ï¼Œä¾æ—§å…ˆçœ‹ 2 ä¸ªé‡è¦çš„æšä¸¾ï¼šSDWebIma">
<meta property="og:locale">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/2208988-29157f1c1fb6719f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="article:published_time" content="2019-01-26T12:01:44.000Z">
<meta property="article:modified_time" content="2022-08-27T15:30:07.155Z">
<meta property="article:author" content="He Hai">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://upload-images.jianshu.io/upload_images/2208988-29157f1c1fb6719f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
  
    <link rel="alternate" href="/atom.xml" title="riversea2015" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">riversea2015</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Stay Hungry, Stay Young.</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://devhe.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-SDWebImage-Source-Learning-04" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/01/26/SDWebImage-Source-Learning-04/" class="article-date">
  <time class="dt-published" datetime="2019-01-26T12:01:44.000Z" itemprop="datePublished">2019-01-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      SDWebImage æºç å­¦ä¹ ç¬”è®° â˜ SDWebImageDownloader
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><img src="https://upload-images.jianshu.io/upload_images/2208988-29157f1c1fb6719f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="SDWebImage-æºç å­¦ä¹ ç¬”è®°.png"></p>
<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>è¿™æ˜¯æœ¬ç³»åˆ—çš„ç¬¬ 4 ç¯‡ï¼Œæœ¬ç¯‡å°†ä¸»è¦ä»‹ç» <code>SDWebImageDownloader</code> è¿™ä¸ªè´Ÿè´£ä¸‹è½½çš„ç±»ï¼Œå½“ç„¶è¿˜æœ‰ä¸€äº›ç›¸å…³ç±»åŠåè®®ï¼Œå¦‚ï¼š <code>SDWebImageDownloadToken</code>ã€<code>SDWebImageDownloaderOperation</code> å’Œ <code>SDWebImageDownloaderOperationInterface</code> ç­‰ã€‚</p>
<h3 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h3><p>å¼€å¯æ­£æ–‡æè¿°ä¹‹å‰ï¼Œä¾æ—§å…ˆçœ‹ 2 ä¸ªé‡è¦çš„æšä¸¾ï¼š<code>SDWebImageDownloaderOptions</code> å’Œ <code>SDWebImageDownloaderExecutionOrder</code>ï¼Œå…·ä½“å«ä¹‰è§ä¸‹æ–¹ä»£ç æ³¨é‡Šã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">// æ§åˆ¶ä¸‹è½½è¿‡ç¨‹çš„é€‰é¡¹</span><br><span class="line">typedef NS_OPTIONS(NSUInteger, SDWebImageDownloaderOptions) &#123;</span><br><span class="line">    // é™ä½ä¸‹è½½ä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­çš„ä¼˜å…ˆçº§</span><br><span class="line">    SDWebImageDownloaderLowPriority = 1 &lt;&lt; 0,</span><br><span class="line">    // å›¾ç‰‡å°†åœ¨ä¸‹è½½è¿‡ç¨‹ä¸­é€æ­¥å±•ç¤ºï¼Œè€Œä¸æ˜¯ç­‰ä¸‹è½½å®Œæˆåæ‰ä¸€æ¬¡æ€§å±•ç¤º</span><br><span class="line">    SDWebImageDownloaderProgressiveDownload = 1 &lt;&lt; 1,</span><br><span class="line">    // ä½¿ç”¨ NSURLCacheï¼Œé»˜è®¤æ˜¯ä¸ä½¿ç”¨çš„</span><br><span class="line">    SDWebImageDownloaderUseNSURLCache = 1 &lt;&lt; 2,</span><br><span class="line">    // å¦‚æœå›¾ç‰‡æ˜¯ä» NSURLCache è¯»å–çš„ï¼Œé‚£ä¹ˆæ‰§è¡Œ completionHandler çš„æ—¶å€™ï¼Œå›ä¼  nil</span><br><span class="line">    SDWebImageDownloaderIgnoreCachedResponse = 1 &lt;&lt; 3,</span><br><span class="line">    // åå°ç»§ç»­æ‰§è¡Œä»»åŠ¡</span><br><span class="line">    SDWebImageDownloaderContinueInBackground = 1 &lt;&lt; 4,</span><br><span class="line">    // å…è®¸å¤„ç†å­˜å‚¨åœ¨ NSHTTPCookieStore ä¸­çš„ Cookie</span><br><span class="line">    SDWebImageDownloaderHandleCookies = 1 &lt;&lt; 5,</span><br><span class="line">    // å…è®¸ä¸å—ä¿¡ä»»çš„ SSL è¯ä¹¦ï¼Œç”Ÿäº§ç¯å¢ƒæ…ç”¨</span><br><span class="line">    SDWebImageDownloaderAllowInvalidSSLCertificates = 1 &lt;&lt; 6,</span><br><span class="line">    // æé«˜ä¸‹è½½ä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­çš„ä¼˜å…ˆçº§</span><br><span class="line">    SDWebImageDownloaderHighPriority = 1 &lt;&lt; 7,</span><br><span class="line">    // ç¼©æ”¾å¤§å›¾</span><br><span class="line">    SDWebImageDownloaderScaleDownLargeImages = 1 &lt;&lt; 8,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// ä»»åŠ¡çš„æ‰§è¡Œé¡ºåº</span><br><span class="line">typedef NS_ENUM(NSInteger, SDWebImageDownloaderExecutionOrder) &#123;</span><br><span class="line">    // å…ˆè¿›å…ˆå‡ºï¼Œä¹Ÿæ˜¯é˜Ÿåˆ—çš„é»˜è®¤æ‰§è¡Œé¡ºåº</span><br><span class="line">    SDWebImageDownloaderFIFOExecutionOrder,</span><br><span class="line">    // åè¿›å…ˆå‡ºï¼Œæ ˆçš„æ‰§è¡Œé¡ºåº</span><br><span class="line">    SDWebImageDownloaderLIFOExecutionOrder</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥å°±åˆ°äº† SDWebImageDownloader è¿™ä¸ªç±»ï¼Œæˆ‘ä¸å‡†å¤‡ä¸€ä¸ªå±æ€§ä¸€ä¸ªæ–¹æ³•åœ°æŒ‰é¡ºåºè®¨è®ºï¼Œè€Œæ˜¯å…ˆè¯´åˆ›å»ºæ–¹æ³•ï¼Œç„¶åé€šè¿‡ä¸€ä¸ªä¸»è¦æ–¹æ³•å°†ä¸»ä½“ä¸²èµ·æ¥ã€‚å…ˆçœ‹åˆ›å»ºæ–¹æ³•å§ï¼</p>
<p>å¯¹å¤–å…¶å®åªå…¬å¼€äº†ä¸€ä¸ªåˆ›å»ºå•ä¾‹çš„æ–¹æ³• <code>sharedDownloader </code>ï¼Œä»”ç»†æŸ¥çœ‹ä»£ç ä¼šå‘ç°ï¼Œæœ€ç»ˆè°ƒç”¨çš„æ˜¯ <code>- (nonnull instancetype)initWithSessionConfiguration:</code> è¿™ä¸ªåˆå§‹åŒ–æ–¹æ³•ï¼Œä¸»è¦åšä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæ–° sessionã€‚å¦‚æœä½¿ç”¨å•ä¾‹æ–¹æ³•åˆ›å»º downloaderï¼Œåˆ™åªä¼šæœ‰ä¸€ä¸ª sessionï¼Œè€Œå¦‚æœé€šè¿‡å…¶ä»–æ–¹æ³•åˆ›å»ºï¼Œåˆ™å¯èƒ½åˆ›å»º session ä¹‹å‰å·²ç»æœ‰ä¸€ä¸ªäº†ï¼Œè¿™æ—¶å€™å°±éœ€è¦å…ˆå°†ä¹‹å‰çš„ cancel ä¹‹åå†åˆ›å»ºæ–°çš„ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">+ (nonnull instancetype)sharedDownloader &#123;</span><br><span class="line">    static dispatch_once_t once;</span><br><span class="line">    static id instance;</span><br><span class="line">    dispatch_once(&amp;once, ^&#123;</span><br><span class="line">        instance = [self new];</span><br><span class="line">    &#125;);</span><br><span class="line">    return instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (nonnull instancetype)init &#123;</span><br><span class="line">    return [self initWithSessionConfiguration:[NSURLSessionConfiguration defaultSessionConfiguration]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (nonnull instancetype)initWithSessionConfiguration:(nullable NSURLSessionConfiguration *)sessionConfiguration &#123;</span><br><span class="line">    if ((self = [super init])) &#123;</span><br><span class="line">        // æ‰§è¡Œä¸‹è½½ä»»åŠ¡çš„ operation</span><br><span class="line">        _operationClass = [SDWebImageDownloaderOperation class];</span><br><span class="line">        // è¦æ±‚è§£å‹å›¾ç‰‡</span><br><span class="line">        _shouldDecompressImages = YES;</span><br><span class="line">        // æ‰§è¡Œé¡ºåºï¼Œå…ˆè¿›å…ˆå‡º</span><br><span class="line">        _executionOrder = SDWebImageDownloaderFIFOExecutionOrder;</span><br><span class="line">        </span><br><span class="line">        // è®¾ç½®ä¸‹è½½æ“ä½œçš„é˜Ÿåˆ—ï¼Œç”±äºæœ€å¤§å¹¶å‘æ•°æ˜¯ 6ï¼Œæ‰€ä»¥æ­¤ queue æ˜¯ å¹¶å‘é˜Ÿåˆ—ï¼Œå¦‚æœæ˜¯ 1ï¼Œåˆ™ä¸ºä¸²è¡Œé˜Ÿåˆ—ã€‚</span><br><span class="line">        _downloadQueue = [NSOperationQueue new];</span><br><span class="line">        _downloadQueue.maxConcurrentOperationCount = 6;</span><br><span class="line">        _downloadQueue.name = @&quot;com.hackemist.SDWebImageDownloader&quot;;</span><br><span class="line">        </span><br><span class="line">        _URLOperations = [NSMutableDictionary new];</span><br><span class="line">        </span><br><span class="line">        // è¯·æ±‚å¤´çš„å­—æ®µï¼Œå¯æ¥å—çš„æ–‡ä»¶ç±»å‹</span><br><span class="line">#ifdef SD_WEBP</span><br><span class="line">        _HTTPHeaders = [@&#123;@&quot;Accept&quot;: @&quot;image/webp,image/*;q=0.8&quot;&#125; mutableCopy];</span><br><span class="line">#else</span><br><span class="line">        _HTTPHeaders = [@&#123;@&quot;Accept&quot;: @&quot;image/*;q=0.8&quot;&#125; mutableCopy];</span><br><span class="line">#endif</span><br><span class="line">        </span><br><span class="line">        // é”ï¼Œè¿™é‡Œä½¿ç”¨äº†ä¿¡å·é‡</span><br><span class="line">        _operationsLock = dispatch_semaphore_create(1);</span><br><span class="line">        _headersLock = dispatch_semaphore_create(1);</span><br><span class="line">        // è¶…æ—¶æ—¶é—´</span><br><span class="line">        _downloadTimeout = 15.0;</span><br><span class="line"></span><br><span class="line">        [self createNewSessionWithConfiguration:sessionConfiguration];</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// åˆ›å»ºæ–°çš„ session</span><br><span class="line">- (void)createNewSessionWithConfiguration:(NSURLSessionConfiguration *)sessionConfiguration &#123;</span><br><span class="line">    // ä¸ºé¿å…å½±å“ï¼Œå…ˆå–æ¶ˆå¯èƒ½å­˜åœ¨çš„ä¸‹è½½ä»»åŠ¡</span><br><span class="line">    [self cancelAllDownloads];</span><br><span class="line"></span><br><span class="line">    // cancel ä¹‹å‰çš„ sessionï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ–°çš„</span><br><span class="line">    if (self.session) &#123;</span><br><span class="line">        [self.session invalidateAndCancel];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sessionConfiguration.timeoutIntervalForRequest = self.downloadTimeout;</span><br><span class="line"></span><br><span class="line">    self.session = [NSURLSession sessionWithConfiguration:sessionConfiguration</span><br><span class="line">                                                 delegate:self</span><br><span class="line">                                            delegateQueue:nil];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ä¸»è¦æ–¹æ³• <code>- (nullable SDWebImageDownloadToken *)downloadImageWithURL:url options:options progress:progressBlock completed:completedBlock</code>ã€‚ç›´æ¥è°ƒç”¨äº†æ·»åŠ è¿›åº¦ä¸å®Œæˆå›è°ƒçš„æ–¹æ³•ï¼Œå¹¶å°†è¿”å›å€¼ä½œä¸ºç»“æœè¿”å›ã€‚</p>
<p>æ·»åŠ è¿›åº¦ä¸å®Œæˆå›è°ƒçš„æ–¹æ³•æˆ‘ä»¬ç¨åå†è®®ï¼Œå…ˆçœ‹ä¸€ä¸‹è°ƒç”¨æ—¶ä¼ å…¥çš„ <code>createCallback </code>ã€‚å°±åšäº†ä¸¤ä»¶äº‹ï¼šå…ˆåˆ›å»ºä¸€ä¸ª requestï¼Œç”¨äºå‡†å¤‡ä¸€äº›åŸºç¡€å‚æ•°ï¼Œç„¶åï¼Œä¾æ® request åˆ›å»º operationï¼Œè¯¦è§ä»£ç æ³¨é‡Š â˜Ÿã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">- (nullable SDWebImageDownloadToken *)downloadImageWithURL:(nullable NSURL *)url</span><br><span class="line">                                                   options:(SDWebImageDownloaderOptions)options</span><br><span class="line">                                                  progress:(nullable SDWebImageDownloaderProgressBlock)progressBlock</span><br><span class="line">                                                 completed:(nullable SDWebImageDownloaderCompletedBlock)completedBlock &#123;</span><br><span class="line">    __weak SDWebImageDownloader *wself = self;</span><br><span class="line"></span><br><span class="line">    return [self addProgressCallback:progressBlock completedBlock:completedBlock forURL:url createCallback:^SDWebImageDownloaderOperation *&#123;</span><br><span class="line">        </span><br><span class="line">        __strong __typeof (wself) sself = wself;</span><br><span class="line">        NSTimeInterval timeoutInterval = sself.downloadTimeout;</span><br><span class="line">        if (timeoutInterval == 0.0) &#123;</span><br><span class="line">            timeoutInterval = 15.0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">// *** 1.åˆ›å»º request</span><br><span class="line">        </span><br><span class="line">        // ä¸ºé¿å…é‡å¤ç¼“å­˜ (NSURLCache + SDImageCache) ï¼Œå¦‚æœæ²¡æœ‰æ˜ç¡®è¦æ±‚ä½¿ç”¨ NSURLCacheï¼Œæˆ‘ä»¬é»˜è®¤å¿½ç•¥æœ¬åœ°ç¼“å­˜</span><br><span class="line">        NSURLRequestCachePolicy cachePolicy = options &amp; SDWebImageDownloaderUseNSURLCache ? NSURLRequestUseProtocolCachePolicy : NSURLRequestReloadIgnoringLocalCacheData;</span><br><span class="line">        NSMutableURLRequest *request = [[NSMutableURLRequest alloc] initWithURL:url</span><br><span class="line">                                                                    cachePolicy:cachePolicy</span><br><span class="line">                                                                timeoutInterval:timeoutInterval];</span><br><span class="line">        // The default is YES - in other words, cookies are sent from and stored to the cookie manager by default.</span><br><span class="line">        request.HTTPShouldHandleCookies = (options &amp; SDWebImageDownloaderHandleCookies);</span><br><span class="line">        request.HTTPShouldUsePipelining = YES;</span><br><span class="line">        </span><br><span class="line">        // è®¾ç½® headerï¼ŒheadersFilter æ˜¯è¿‡æ»¤å¤´éƒ¨å‚æ•°çš„block</span><br><span class="line">        if (sself.headersFilter) &#123;</span><br><span class="line">            request.allHTTPHeaderFields = sself.headersFilter(url, [sself allHTTPHeaderFields]);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            request.allHTTPHeaderFields = [sself allHTTPHeaderFields];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">// *** 2.åˆ›å»ºä¸‹è½½çš„ operation (è¿™ä¸ª operationClass ï¼Œç»™ä»–èµ‹ä»€ä¹ˆå€¼ï¼Œä»–å°±æ˜¯ä»€ä¹ˆï¼Œå¦‚æœä¸è®¾ç½®ï¼Œå°±æ˜¯é»˜è®¤å€¼ï¼š[SDWebImageDownloaderOperation class])</span><br><span class="line">        </span><br><span class="line">        SDWebImageDownloaderOperation *operation = [[sself.operationClass alloc] initWithRequest:request</span><br><span class="line">                                                                                       inSession:sself.session</span><br><span class="line">                                                                                         options:options];</span><br><span class="line">        </span><br><span class="line">        operation.shouldDecompressImages = sself.shouldDecompressImages;</span><br><span class="line">        </span><br><span class="line">        // NSURLCredential èº«ä»½è®¤è¯</span><br><span class="line">        if (sself.urlCredential) &#123;</span><br><span class="line">            operation.credential = sself.urlCredential;</span><br><span class="line">        &#125; else if (sself.username &amp;&amp; sself.password) &#123;</span><br><span class="line">            // NSURLCredentialPersistenceForSession: Credential should be stored only for this session.</span><br><span class="line">            operation.credential = [NSURLCredential credentialWithUser:sself.username password:sself.password persistence:NSURLCredentialPersistenceForSession];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // è®¾ç½®ä¼˜å…ˆçº§</span><br><span class="line">        if (options &amp; SDWebImageDownloaderHighPriority) &#123;</span><br><span class="line">            operation.queuePriority = NSOperationQueuePriorityHigh;</span><br><span class="line">        &#125; else if (options &amp; SDWebImageDownloaderLowPriority) &#123;</span><br><span class="line">            operation.queuePriority = NSOperationQueuePriorityLow;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ›´æ”¹æ‰§è¡Œé¡ºåºï¼šå…ˆè¿›åå‡º(å¯åœ¨æ­¤è®¾ç½®) or å…ˆè¿›å…ˆå‡º(é»˜è®¤)</span><br><span class="line">        if (sself.executionOrder == SDWebImageDownloaderLIFOExecutionOrder) &#123;</span><br><span class="line">            // é€šè¿‡åå‘è®¾ç½®ä¾èµ–ï¼ŒæŒ‡å®šäº†é˜Ÿåˆ—ä¸­ä»»åŠ¡çš„æ‰§è¡Œé¡ºåºå…ˆåŠ è¿›å»çš„ä¾èµ–äºååŠ è¿›å»çš„ï¼Œé‚£å°±æˆäº†åè¿›å…ˆå‡ºäº†ğŸ˜</span><br><span class="line">            [sself.lastAddedOperation addDependency:operation];</span><br><span class="line">            sself.lastAddedOperation = operation;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return operation;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æ·»åŠ è¿›åº¦ä¸å®Œæˆå›è°ƒçš„æ–¹æ³•ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">- (nullable SDWebImageDownloadToken *)addProgressCallback:(SDWebImageDownloaderProgressBlock)progressBlock</span><br><span class="line">                                           completedBlock:(SDWebImageDownloaderCompletedBlock)completedBlock</span><br><span class="line">                                                   forURL:(nullable NSURL *)url</span><br><span class="line">                                           createCallback:(SDWebImageDownloaderOperation *(^)(void))createCallback &#123;</span><br><span class="line">    // The URL will be used as the key to the callbacks dictionary so it cannot be nil. If it is nil immediately call the completed block with no image or data.</span><br><span class="line">    if (url == nil) &#123;</span><br><span class="line">        if (completedBlock != nil) &#123;</span><br><span class="line">            completedBlock(nil, nil, nil, NO);</span><br><span class="line">        &#125;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    LOCK(self.operationsLock);</span><br><span class="line">    </span><br><span class="line">    SDWebImageDownloaderOperation *operation = [self.URLOperations objectForKey:url];</span><br><span class="line">    </span><br><span class="line">    // å¦‚æœæ˜¯ç¬¬ 1 æ¬¡è¿›æ¥ï¼Œé€šè¿‡ url æ˜¯å–ä¸å‡º URLOperation çš„ï¼Œä½†æ˜¯ç¬¬ 2 æ¬¡å°±æœ‰å¯èƒ½æ‰¾åˆ°ï¼Œä¹Ÿå°±æ˜¯æƒ³è¦é‡å¤å‘ç¬¬ 2 æ¬¡è¯·æ±‚çš„è¯ï¼Œå°±å¯ä»¥å–åˆ°ã€‚</span><br><span class="line">    // ç¬¬ 2 æ¬¡å¯ä»¥å–åˆ°(å¹¶ä¸”å·²ç»å®Œæˆçš„æƒ…å†µä¸‹)ï¼Œåˆ™ä¸ä¼šèµ°æ‹¬å·é‡Œè¾¹ï¼Œä¹Ÿå°±ä¸ä¼šæ‰§è¡Œå…³é”®æ­¥éª¤ï¼š[self.downloadQueue addOperation:operation]; ï¼Œæ‰€ä»¥å°±ä¸ä¼šå‘èµ·è¯·æ±‚äº†ï¼Œå› ä¸ºå°† operation æ·»åŠ åˆ°é˜Ÿåˆ—çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è§¦å‘è¯·æ±‚ã€‚</span><br><span class="line">    if (!operation || operation.isFinished) &#123;</span><br><span class="line">        // åˆ›å»º operation</span><br><span class="line">        operation = createCallback();</span><br><span class="line">        __weak typeof(self) wself = self;</span><br><span class="line">        operation.completionBlock = ^&#123;</span><br><span class="line">            __strong typeof(wself) sself = wself;</span><br><span class="line">            if (!sself) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            LOCK(sself.operationsLock);</span><br><span class="line">            [sself.URLOperations removeObjectForKey:url];</span><br><span class="line">            UNLOCK(sself.operationsLock);</span><br><span class="line">        &#125;;</span><br><span class="line">        [self.URLOperations setObject:operation forKey:url];</span><br><span class="line">        </span><br><span class="line">        // æ·»åŠ åˆ°é˜Ÿåˆ—ï¼Œå³å¼€å§‹æ‰§è¡Œï¼</span><br><span class="line">        // Add operation to operation queue only after all configuration done according to Apple&#x27;s doc.</span><br><span class="line">        // `addOperation:` does not synchronously execute the `operation.completionBlock` so this will not cause deadlock.</span><br><span class="line">        [self.downloadQueue addOperation:operation];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    UNLOCK(self.operationsLock);</span><br><span class="line"></span><br><span class="line">    // å­˜æ”¾è¿›åº¦å’Œå®Œæˆå›è°ƒçš„ æ•°ç»„ array</span><br><span class="line">    id downloadOperationCancelToken = [operation addHandlersForProgress:progressBlock completed:completedBlock];</span><br><span class="line">    </span><br><span class="line">    // ä¸ä¸‹è½½ä»»åŠ¡å…³è”çš„ä¸€ä¸ªå¯¹è±¡ï¼Œç”¨äºå–æ¶ˆæ“ä½œçš„æ—¶å€™</span><br><span class="line">    SDWebImageDownloadToken *token = [SDWebImageDownloadToken new];</span><br><span class="line">    token.downloadOperation = operation;</span><br><span class="line">    token.url = url;</span><br><span class="line">    token.downloadOperationCancelToken = downloadOperationCancelToken;</span><br><span class="line"></span><br><span class="line">    return token;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸»è¦åšäº†è¿™ä¹ˆå‡ ä»¶äº‹ï¼š</p>
<ul>
<li><p>å¼€å§‹ä¾ç„¶æ˜¯å‚æ•°æ ¡éªŒ</p>
</li>
<li><p>ç„¶åä» self.URLOperation é‡Œè¾¹å– operation</p>
</li>
<li><p>ç¬¬ä¸€æ¬¡è¿›æ¥å½“ç„¶å–ä¸åˆ° operationï¼Œäºæ˜¯å°±ä¼šè¿›å…¥ <code> if (!operation || operation.isFinished) &#123; ... &#125;</code> çš„ä»£ç å—ã€‚å…ˆæ‰§è¡Œæˆ‘ä»¬ä¼ å…¥çš„ <code>createCallback()</code> åˆ›å»º operationï¼Œç„¶åå°† operation åŠ å…¥åˆ° self.URLOperations é‡Œè¾¹ï¼ŒåŒæ—¶è®¾ç½®å¥½ operation çš„ completionBlockï¼Œåˆ°æ—¶å°† operation ç§»é™¤ï¼Œæœ€åå°† operation åŠ å…¥åˆ°æ“ä½œé˜Ÿåˆ—é‡Œï¼Œå°±ä¼šè‡ªåŠ¨å¼€å§‹æ‰§è¡Œäº†ã€‚</p>
</li>
<li><p>åˆ›å»ºä¸€ä¸ª tokenï¼Œä»–æ˜¯ <code>SDWebImageDownloadToken</code> çš„å®ä¾‹ï¼Œå°†å®ƒä¸ operationã€urlã€progressBlock  åŠ completedBlock å…³è”èµ·æ¥ï¼Œç”¨äºåè¾¹ä¹‹åçš„å–æ¶ˆæ“ä½œã€‚å…¶ä¸­ progressBlock  åŠ completedBlock æ˜¯é€šè¿‡ downloadOperationCancelToken ä¸ token å…³è”èµ·æ¥çš„ï¼Œè¿™é‡Œç”¨åˆ°äº† operation ä¸­çš„ä¸€ä¸ªæ–¹æ³•ï¼š</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// SDWebImageDownloaderOperation</span><br><span class="line"></span><br><span class="line">- (nullable id)addHandlersForProgress:(nullable SDWebImageDownloaderProgressBlock)progressBlock</span><br><span class="line">                            completed:(nullable SDWebImageDownloaderCompletedBlock)completedBlock &#123;</span><br><span class="line">    </span><br><span class="line">    SDCallbacksDictionary *callbacks = [NSMutableDictionary new];</span><br><span class="line">    </span><br><span class="line">    if (progressBlock) callbacks[kProgressCallbackKey] = [progressBlock copy];</span><br><span class="line">    </span><br><span class="line">    if (completedBlock) callbacks[kCompletedCallbackKey] = [completedBlock copy];</span><br><span class="line">    </span><br><span class="line">    LOCK(self.callbacksLock);</span><br><span class="line">    </span><br><span class="line">    [self.callbackBlocks addObject:callbacks];</span><br><span class="line">    </span><br><span class="line">    UNLOCK(self.callbacksLock);</span><br><span class="line">    </span><br><span class="line">    return callbacks;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±æ­¤å¯çŸ¥ï¼Œè¿™ä¸ª <code>id downloadOperationCancelToken</code> æ˜¯ä¸€ä¸ªå­˜æ”¾ progressBlock å’Œ completedBlock çš„ dictionaryã€‚</p>
<p>è¿™é‡Œ if è¯­å¥èµ·åˆ°äº†ä¸€ä¸ªéå¸¸é‡è¦çš„ä½œç”¨ï¼Œå³ é¿å…é‡å¤ä¸‹è½½ç›¸åŒæ•°æ®ï¼Œå…·ä½“åŸå› å°±ä¸è§£é‡Šäº†ï¼Œä¸Šè¾¹çš„ä»£ç æ³¨é‡Šé‡Œå·²ç»å†™äº†ã€‚</p>
<p>åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯è§‰å¾—å°‘äº†ç‚¹ä»€ä¹ˆï¼Œæ˜¯çš„ï¼Œ<code>SDWebImageDownloaderOperation</code> å’Œ <code>SDWebImageDownloadToken</code> çš„å…·ä½“å®ç°è¿˜ä¸çŸ¥é“å‘¢ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±åˆ†åˆ«æŸ¥çœ‹è¿™ 2 ä¸ªç±»ï¼Œå…ˆä»ç®€å•çš„å¼€å§‹å§ï¼</p>
<h5 id="SDWebImageDownloadToken"><a href="#SDWebImageDownloadToken" class="headerlink" title="SDWebImageDownloadToken"></a>SDWebImageDownloadToken</h5><p>è¿™ä¸ªç±»åªæœ‰ 3 ä¸ªå±æ€§ï¼Œå‰è¾¹éƒ½ç”¨åˆ°äº†ï¼Œå±æ€§å£°æ˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// ä¸‹è½½ä»»åŠ¡å¯¹åº”çš„ url</span><br><span class="line">@property (nonatomic, strong, nullable) NSURL *url;</span><br><span class="line">// å®é™…æ˜¯åŒ…å« progressBlock å’Œ completionBlock çš„å­—å…¸ï¼Œæ˜¯é€šè¿‡ `addHandlersForProgress:completed:` è¿”å›çš„ï¼Œç”¨äºå–æ¶ˆæ“ä½œ</span><br><span class="line">@property (nonatomic, strong, nullable) id downloadOperationCancelToken;</span><br><span class="line">// æ“ä½œçš„ operationï¼Œç»§æ‰¿è‡ª NSOperationï¼Œä¸è¿‡åˆéµå®ˆäº† `SDWebImageDownloaderOperationInterface` è¿™ä¸ªåè®®ï¼Œæ‰©å±•äº†ä¸€äº›æ–¹æ³•ã€‚</span><br><span class="line">@property (nonatomic, weak, nullable) NSOperation&lt;SDWebImageDownloaderOperationInterface&gt; *downloadOperation;</span><br></pre></td></tr></table></figure>

<p>å®ƒåªå®ç°äº†ä¸€ä¸ªåè®®æ–¹æ³• <code>cancel</code>ï¼ˆProtocol: SDWebImageOperationï¼‰ï¼Œå…¶ä¸­ <code>self.downloadOperationCancelToken</code>å°±æ˜¯å­˜æ”¾ progressBlock å’Œ completionBlock çš„å­—å…¸ï¼Œç„¶åå°†è¿™ä¸ª token åˆ›é€’ç»™äº† operation çš„ <code>cancel:</code> æ–¹æ³•ï¼ˆä¹Ÿæ˜¯ä¸€ä¸ªåè®®æ–¹æ³•ï¼‰ï¼Œè¿™ä¸ªæ–¹æ³•çš„å…·ä½“å®ç°ä¸‹è¾¹å°±ä¼šè¯´åˆ°ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (void)cancel &#123;</span><br><span class="line">    if (self.downloadOperation) &#123;</span><br><span class="line">        SDWebImageDownloadToken *cancelToken = self.downloadOperationCancelToken;</span><br><span class="line">        if (cancelToken) &#123;</span><br><span class="line">            [self.downloadOperation cancel:cancelToken];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="SDWebImageDownloaderOperationInterface"><a href="#SDWebImageDownloaderOperationInterface" class="headerlink" title="SDWebImageDownloaderOperationInterface"></a>SDWebImageDownloaderOperationInterface</h5><p>åœ¨å¼€å§‹ä»‹ç» operation ä¹‹å‰ï¼Œå…ˆçœ‹çœ‹ä»–éµå®ˆçš„åè®® <code>SDWebImageDownloaderOperationInterface</code>ï¼Œå£°æ˜äº†ä»¥ä¸‹åè®®æ–¹æ³•ã€‚å¦‚æœæƒ³è¦ä½¿ç”¨è‡ªå®šä¹‰çš„ operationï¼Œåˆ™å®ƒå¿…é¡»ç»§æ‰¿è‡ª NSOperation å¹¶ä¸”éµå®ˆè¿™ä¸ªåè®®ã€‚è¿™äº›æ–¹æ³•çš„å®ç°å¯ä»¥å‚è€ƒ <code>SDWebImageDownloaderOperation </code>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// SDWebImageDownloaderOperationInterface</span><br><span class="line">// åˆå§‹åŒ–æ–¹æ³•</span><br><span class="line">- (nonnull instancetype)initWithRequest:(nullable NSURLRequest *)request</span><br><span class="line">                              inSession:(nullable NSURLSession *)session</span><br><span class="line">                                options:(SDWebImageDownloaderOptions)options;</span><br><span class="line">// ä¿å­˜è¿›åº¦å’Œå®Œæˆçš„å›è°ƒ</span><br><span class="line">- (nullable id)addHandlersForProgress:(nullable SDWebImageDownloaderProgressBlock)progressBlock</span><br><span class="line">                            completed:(nullable SDWebImageDownloaderCompletedBlock)completedBlock;</span><br><span class="line">// æ˜¯å¦éœ€è¦è§£å‹å›¾ç‰‡</span><br><span class="line">- (BOOL)shouldDecompressImages;</span><br><span class="line">- (void)setShouldDecompressImages:(BOOL)value;</span><br><span class="line">// å‡­è¯æˆ–ç§°è¯ä¹¦ä¿¡æ¯</span><br><span class="line">- (nullable NSURLCredential *)credential;</span><br><span class="line">- (void)setCredential:(nullable NSURLCredential *)value;</span><br><span class="line">// å–æ¶ˆ</span><br><span class="line">- (BOOL)cancel:(nullable id)token;</span><br></pre></td></tr></table></figure>

<h5 id="SDWebImageDownloaderOperation"><a href="#SDWebImageDownloaderOperation" class="headerlink" title="SDWebImageDownloaderOperation"></a>SDWebImageDownloaderOperation</h5><p>ç°åœ¨å¼€å§‹è®¨è®º <code>SDWebImageDownloaderOperation</code> è¿™ä¸ªç±»ï¼Œä¸‹è¾¹æ˜¯åˆå§‹åŒ–æ–¹æ³•ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (nonnull instancetype)init &#123;</span><br><span class="line">    return [self initWithRequest:nil inSession:nil options:0];</span><br><span class="line">&#125;</span><br><span class="line">// ä¹Ÿæ˜¯åè®®æ–¹æ³•</span><br><span class="line">- (nonnull instancetype)initWithRequest:(nullable NSURLRequest *)request</span><br><span class="line">                              inSession:(nullable NSURLSession *)session</span><br><span class="line">                                options:(SDWebImageDownloaderOptions)options &#123;</span><br><span class="line">    if ((self = [super init])) &#123;</span><br><span class="line">        _request = [request copy];</span><br><span class="line">        _shouldDecompressImages = YES;</span><br><span class="line">        _options = options;</span><br><span class="line">        _callbackBlocks = [NSMutableArray new];</span><br><span class="line">        _executing = NO;</span><br><span class="line">        _finished = NO;</span><br><span class="line">        _expectedSize = 0;</span><br><span class="line">        _unownedSession = session;</span><br><span class="line">        _callbacksLock = dispatch_semaphore_create(1);</span><br><span class="line">        _coderQueue = dispatch_queue_create(&quot;com.hackemist.SDWebImageDownloaderOperationCoderQueue&quot;, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢ä»‹ç» 2 ä¸ªæ¯”è¾ƒé‡è¦çš„æ–¹æ³•ï¼š</p>
<ul>
<li>æ ¸å¿ƒæ–¹æ³• start</li>
</ul>
<p>è¿™æ˜¯é‡å†™çˆ¶ç±» NSOperation çš„ start æ–¹æ³•ï¼Œæ·»åŠ äº†è‡ªå®šä¹‰çš„æ“ä½œã€‚è¿™ä¸ªæ–¹æ³•ä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨ï¼Œåœ¨å°† operation æ·»åŠ åˆ° operationQueue ä¸­çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è°ƒç”¨å…¶ start æ–¹æ³•ã€‚é‡å†™åçš„æ“ä½œåŒ…æ‹¬ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<p>â‘ æ£€æµ‹æ“ä½œæ˜¯å¦å·²å–æ¶ˆï¼Œå¦‚æœå–æ¶ˆäº†ï¼Œé‡ç½®æ•°æ®åç›´æ¥è¿”å›ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if (self.isCancelled) &#123;</span><br><span class="line">    self.finished = YES;</span><br><span class="line">    [self reset];</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â‘¡å¦‚æœéœ€è¦ App è¿›å…¥åå°æ—¶ï¼Œç»§ç»­æ‰§è¡Œä¸‹è½½æ“ä½œï¼Œéœ€è¦å¼€å¯åå°ä»»åŠ¡ã€‚å¹¶è®¾ç½® ExpirationHandlerï¼Œå–æ¶ˆä¸‹è½½ä»»åŠ¡ï¼Œå¹¶ç»“æŸåå°æ“ä½œã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// å¦‚æœéœ€è¦Appè¿›å…¥åå°æ—¶ï¼Œç»§ç»­æ‰§è¡Œæ­¤æ“ä½œï¼Œéœ€è¦å¼€å¯åå°ä»»åŠ¡ã€‚</span><br><span class="line">Class UIApplicationClass = NSClassFromString(@&quot;UIApplication&quot;);</span><br><span class="line">BOOL hasApplication = UIApplicationClass &amp;&amp; [UIApplicationClass respondsToSelector:@selector(sharedApplication)];</span><br><span class="line">if (hasApplication &amp;&amp; [self shouldContinueWhenAppEntersBackground]) &#123;</span><br><span class="line">    __weak __typeof__ (self) wself = self;</span><br><span class="line">    UIApplication * app = [UIApplicationClass performSelector:@selector(sharedApplication)];</span><br><span class="line">    self.backgroundTaskId = [app beginBackgroundTaskWithExpirationHandler:^&#123;</span><br><span class="line">        __strong __typeof (wself) sself = wself;</span><br><span class="line"></span><br><span class="line">        if (sself) &#123;</span><br><span class="line">            [sself cancel];</span><br><span class="line"></span><br><span class="line">            [app endBackgroundTask:sself.backgroundTaskId];</span><br><span class="line">            sself.backgroundTaskId = UIBackgroundTaskInvalid;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â‘¢è·å–æˆ–åˆ›å»º sessionï¼Œç„¶ååˆ›å»º dataTaskï¼Œ</p>
<p>â‘£è‹¥ dataTask åˆ›å»ºæˆåŠŸï¼Œå¯åŠ¨ä¸‹è½½ä»»åŠ¡ <code> [self.dataTask resume];</code>ï¼Œç„¶åæ‰§è¡Œä¸€æ¬¡ progressBlockï¼Œå¹¶å‘é€å¼€å§‹ä¸‹è½½çš„é€šçŸ¥ã€‚</p>
<p>â‘£è‹¥ dataTask åˆ›å»ºå¤±è´¥ï¼Œç›´æ¥è°ƒç”¨å®Œæˆå›è°ƒï¼Œæ„å»º error ä¿¡æ¯å¹¶è¿”å›ï¼Œç„¶åé‡ç½®æ•°æ®ã€‚</p>
<p>â‘¤å…³é—­å¯èƒ½å­˜åœ¨çš„åå°ä¸‹è½½ä»»åŠ¡ã€‚</p>
<p>å…·ä½“ä¸‹è½½è¿‡ç¨‹ä¸­çš„æ“ä½œï¼Œéƒ½åœ¨ session ç›¸å…³çš„é‚£äº›åè®®æ–¹æ³•é‡Œè¾¹ï¼Œè¯¦è§ä»£ç æ³¨é‡Šï¼Œè¿™é‡Œå°±ä¸å•°å—¦äº†ã€‚</p>
<ul>
<li>å–æ¶ˆæ“ä½œ</li>
</ul>
<p>æœ€åçœ‹ä¸€ä¸‹å–æ¶ˆæ“ä½œï¼Œå³åè®®æ–¹æ³• <code>- (BOOL)cancel:(nullable id)token;</code> çš„å®ç°ï¼Œå°†å–æ¶ˆè¿‡ç¨‹ä¸­ç”¨åˆ°çš„æ‰€æœ‰æ–¹æ³•éƒ½å±•å¼€å°±æ˜¯ä¸‹è¾¹è¿™æ ·ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)cancel:(nullable id)token &#123;</span><br><span class="line">    BOOL shouldCancel = NO;</span><br><span class="line">    </span><br><span class="line">    LOCK(self.callbacksLock);</span><br><span class="line">    </span><br><span class="line">    // ç§»é™¤ tokenï¼Œå³ç§»é™¤ä¸€ä¸ªå­˜å‚¨ç€ completionBlock å’Œ progressBlock çš„å­—å…¸</span><br><span class="line">    [self.callbackBlocks removeObjectIdenticalTo:token];</span><br><span class="line">    </span><br><span class="line">    // å¦‚æœå·²ç»æ²¡æœ‰å›è°ƒï¼Œå°±å»æ‰§è¡Œæ•´ä½“çš„ cancel æ“ä½œ</span><br><span class="line">    if (self.callbackBlocks.count == 0) &#123;</span><br><span class="line">        shouldCancel = YES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    UNLOCK(self.callbacksLock);</span><br><span class="line">    </span><br><span class="line">    if (shouldCancel) &#123;</span><br><span class="line">        // *** ç‚¹å¼€ â˜Ÿ</span><br><span class="line">        [self cancel];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return shouldCancel;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)cancel &#123;</span><br><span class="line">    @synchronized (self) &#123;</span><br><span class="line">        // *** ç‚¹å¼€ â˜Ÿ</span><br><span class="line">        [self cancelInternal];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)cancelInternal &#123;</span><br><span class="line">    if (self.isFinished) return;</span><br><span class="line">    [super cancel];</span><br><span class="line"></span><br><span class="line">    if (self.dataTask) &#123;</span><br><span class="line">        // å–æ¶ˆä¸‹è½½ä»»åŠ¡ï¼Œå¹¶å‘å‡ºåœæ­¢çš„é€šçŸ¥</span><br><span class="line">        [self.dataTask cancel];</span><br><span class="line">        __weak typeof(self) weakSelf = self;</span><br><span class="line">        dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            [[NSNotificationCenter defaultCenter] postNotificationName:SDWebImageDownloadStopNotification object:weakSelf];</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // As we cancelled the task, its callback won&#x27;t be called and thus won&#x27;t</span><br><span class="line">        // maintain the isFinished and isExecuting flags.</span><br><span class="line">        if (self.isExecuting) self.executing = NO;</span><br><span class="line">        if (!self.isFinished) self.finished = YES;</span><br><span class="line">    &#125;</span><br><span class="line">    // *** ç‚¹å¼€ â˜Ÿ</span><br><span class="line">    [self reset];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// é‡ç½®å˜é‡</span><br><span class="line">- (void)reset &#123;</span><br><span class="line">    LOCK(self.callbacksLock);</span><br><span class="line">    [self.callbackBlocks removeAllObjects];</span><br><span class="line">    UNLOCK(self.callbacksLock);</span><br><span class="line">    self.dataTask = nil;</span><br><span class="line">    </span><br><span class="line">    if (self.ownedSession) &#123;</span><br><span class="line">        [self.ownedSession invalidateAndCancel];</span><br><span class="line">        self.ownedSession = nil;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p>SDWebImageDownloader çš„å†…å®¹å°±å…ˆä»‹ç»åˆ°è¿™ç±»ï¼Œå…¶ä»–ç»†èŠ‚è§ <a target="_blank" rel="noopener" href="https://github.com/riversea2015/CodeForBlogs/tree/master/HHSDWebImageStudy">HHSDWebImageStudy</a> ä¸­çš„æºç æ³¨é‡Šã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://devhe.com/2019/01/26/SDWebImage-Source-Learning-04/" data-id="cl7c27fgx0002jlfy9ochh1nh" data-title="SDWebImage æºç å­¦ä¹ ç¬”è®° â˜ SDWebImageDownloader" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/02/03/SDWebImage-Source-Learning-05/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          SDWebImage æºç å­¦ä¹ ç¬”è®° â˜ SDImageCache
        
      </div>
    </a>
  
  
    <a href="/2019/01/20/SDWebImage-Source-Learning-03/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">SDWebImage æºç å­¦ä¹ ç¬”è®° â˜ SDWebImageManager</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/08/24/ijkplayer-Compilation-and-Packaging/">ijkplayer ç¼–è¯‘-æ‰“åŒ…-Podæ”¯æŒ</a>
          </li>
        
          <li>
            <a href="/2022/08/23/Topics-and-mentions-similar-to-Weibo/">iOS UITextView å®ç°ç±»ä¼¼å¾®åšçš„è¯é¢˜ã€æåŠåŠŸèƒ½</a>
          </li>
        
          <li>
            <a href="/2019/02/03/SDWebImage-Source-Learning-05/">SDWebImage æºç å­¦ä¹ ç¬”è®° â˜ SDImageCache</a>
          </li>
        
          <li>
            <a href="/2019/01/26/SDWebImage-Source-Learning-04/">SDWebImage æºç å­¦ä¹ ç¬”è®° â˜ SDWebImageDownloader</a>
          </li>
        
          <li>
            <a href="/2019/01/20/SDWebImage-Source-Learning-03/">SDWebImage æºç å­¦ä¹ ç¬”è®° â˜ SDWebImageManager</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 He Hai<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>